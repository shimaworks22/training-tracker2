<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>TRAINING TRACKERï½œãƒˆãƒ¬ãƒ¼ãƒ‹ãƒ³ã‚° & ä½“é‡ç®¡ç†</title>
<link href="https://fonts.googleapis.com/css2?family=Barlow+Condensed:wght@400;600;700;800;900&family=Noto+Sans+JP:wght@300;400;500;600;700&display=swap" rel="stylesheet">
<script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/4.4.0/chart.umd.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2.45.4/dist/umd/supabase.js"></script>
<style>
  :root {
    --bg:       #080E14;
    --bg2:      #0D1720;
    --bg3:      #111E2A;
    --border:   #1A3044;
    --accent:   #00D4FF;
    --green:    #3DFF8F;
    --red:      #FF4D6A;
    --gold:     #FFD166;
    --text:     #D8EAF5;
    --muted:    #4A6578;
    --muted2:   #2A3F52;
    --font-display: 'Barlow Condensed', sans-serif;
    --font-body:    'Noto Sans JP', sans-serif;
  }
  *, *::before, *::after { box-sizing: border-box; margin: 0; padding: 0; }
  body {
    background: var(--bg);
    color: var(--text);
    font-family: var(--font-body);
    min-height: 100vh;
    font-size: 14px;
  }
  ::-webkit-scrollbar { width: 5px; }
  ::-webkit-scrollbar-track { background: var(--bg); }
  ::-webkit-scrollbar-thumb { background: var(--border); border-radius: 3px; }

  /* â”€â”€â”€ HEADER â”€â”€â”€ */
  .header {
    background: linear-gradient(180deg, #0B1620 0%, transparent 100%);
    border-bottom: 1px solid var(--border);
    padding: 14px 24px;
    display: flex;
    align-items: center;
    justify-content: space-between;
    position: sticky;
    top: 0;
    z-index: 200;
    backdrop-filter: blur(12px);
  }
  .header-logo {
    display: flex;
    align-items: center;
    gap: 12px;
  }
  .logo-icon {
    width: 38px; height: 38px;
    background: linear-gradient(135deg, var(--accent), #0080AA);
    border-radius: 10px;
    display: flex; align-items: center; justify-content: center;
    font-size: 20px;
  }
  .logo-text { line-height: 1; }
  .logo-title {
    font-family: var(--font-display);
    font-size: 22px;
    font-weight: 900;
    letter-spacing: 0.12em;
    color: var(--accent);
  }
  .logo-sub {
    font-size: 9px;
    color: var(--muted);
    letter-spacing: 0.18em;
    text-transform: uppercase;
    margin-top: 1px;
  }
  .header-actions { display: flex; gap: 10px; }

  /* â”€â”€â”€ HAMBURGER â”€â”€â”€ */
  .hamburger-btn {
    width: 40px; height: 40px;
    background: none;
    border: 1px solid var(--border);
    border-radius: 8px;
    cursor: pointer;
    display: flex; flex-direction: column;
    align-items: center; justify-content: center;
    gap: 5px;
    padding: 8px;
    transition: border-color 0.2s;
  }
  .hamburger-btn:hover { border-color: var(--accent); }
  .hamburger-btn span {
    display: block; width: 18px; height: 2px;
    background: var(--text);
    border-radius: 2px;
    transition: all 0.25s;
  }
  .hamburger-btn.open span:nth-child(1) { transform: translateY(7px) rotate(45deg); }
  .hamburger-btn.open span:nth-child(2) { opacity: 0; transform: scaleX(0); }
  .hamburger-btn.open span:nth-child(3) { transform: translateY(-7px) rotate(-45deg); }

  /* â”€â”€â”€ DRAWER â”€â”€â”€ */
  .drawer-overlay {
    display: none;
    position: fixed; inset: 0;
    background: rgba(0,0,0,0.55);
    z-index: 300;
    backdrop-filter: blur(2px);
  }
  .drawer-overlay.open { display: block; }
  .drawer {
    position: fixed; top: 0; left: 0;
    width: 260px; height: 100vh;
    background: var(--bg2);
    border-right: 1px solid var(--border);
    z-index: 400;
    transform: translateX(-100%);
    transition: transform 0.28s cubic-bezier(0.4,0,0.2,1);
    display: flex; flex-direction: column;
    overflow-y: auto;
  }
  .drawer.open { transform: translateX(0); }
  .drawer-header {
    padding: 20px 20px 16px;
    border-bottom: 1px solid var(--border);
    display: flex; align-items: center; gap: 12px;
  }
  .drawer-logo-icon {
    width: 36px; height: 36px;
    background: linear-gradient(135deg, var(--accent), #0080AA);
    border-radius: 9px;
    display: flex; align-items: center; justify-content: center;
    font-size: 18px; flex-shrink: 0;
  }
  .drawer-logo-title {
    font-family: var(--font-display);
    font-size: 17px; font-weight: 900;
    letter-spacing: 0.1em; color: var(--accent);
    line-height: 1;
  }
  .drawer-logo-sub {
    font-size: 9px; color: var(--muted);
    letter-spacing: 0.15em; margin-top: 2px;
  }
  .drawer-nav {
    flex: 1; padding: 12px 0;
  }
  .drawer-nav-btn {
    display: flex; align-items: center; gap: 14px;
    width: 100%; padding: 14px 20px;
    background: none; border: none;
    color: var(--muted);
    font-family: var(--font-body); font-size: 14px; font-weight: 600;
    cursor: pointer; text-align: left;
    letter-spacing: 0.03em;
    transition: all 0.15s;
    border-left: 3px solid transparent;
  }
  .drawer-nav-btn:hover { color: var(--text); background: rgba(255,255,255,0.03); }
  .drawer-nav-btn.active {
    color: var(--accent);
    border-left-color: var(--accent);
    background: rgba(0,212,255,0.06);
  }
  .drawer-nav-btn .nav-icon { font-size: 18px; width: 24px; text-align: center; }
  .drawer-footer {
    padding: 16px 20px;
    border-top: 1px solid var(--border);
    position: sticky;
    bottom: 0;
    background: var(--bg2);
  }
  .drawer-logout-btn {
    display: flex; align-items: center; gap: 10px;
    width: 100%; padding: 12px 14px;
    background: rgba(255,77,106,0.08);
    border: 1px solid rgba(255,77,106,0.2);
    border-radius: 8px; cursor: pointer;
    color: var(--red); font-family: var(--font-body);
    font-size: 13px; font-weight: 600;
    transition: all 0.2s;
  }
  .drawer-logout-btn:hover { background: rgba(255,77,106,0.15); }

  /* â”€â”€â”€ NAVï¼ˆæ—§ã‚¿ãƒ–éè¡¨ç¤ºï¼‰ â”€â”€â”€ */
  .nav { display: none; }
  .nav-btn { display: none; }

  /* â”€â”€â”€ CONTENT â”€â”€â”€ */
  .content {
    max-width: 1200px;
    margin: 0 auto;
    padding: 28px 24px;
  }
  .section { display: none; }
  .section.active { display: block; }

  /* â”€â”€â”€ BUTTONS â”€â”€â”€ */
  .btn {
    border: none;
    border-radius: 8px;
    padding: 9px 18px;
    font-family: var(--font-body);
    font-size: 13px;
    font-weight: 600;
    cursor: pointer;
    transition: all 0.18s;
    letter-spacing: 0.02em;
  }
  .btn-primary {
    background: linear-gradient(135deg, var(--accent), #008FAA);
    color: #000;
  }
  .btn-primary:hover { opacity: 0.85; transform: translateY(-1px); }
  .btn-success {
    background: rgba(61,255,143,0.15);
    color: var(--green);
    border: 1px solid rgba(61,255,143,0.3);
  }
  .btn-success:hover { background: rgba(61,255,143,0.25); }
  .btn-danger {
    background: rgba(255,77,106,0.12);
    color: var(--red);
    border: 1px solid rgba(255,77,106,0.25);
    padding: 5px 12px;
    font-size: 11px;
  }
  .btn-danger:hover { background: rgba(255,77,106,0.22); }
  .btn-ghost {
    background: transparent;
    color: var(--muted);
    border: none;
  }
  .btn-ghost:hover { color: var(--text); }
  .btn-sm { padding: 5px 12px; font-size: 11px; }
  .btn:disabled { opacity: 0.4; cursor: not-allowed; transform: none !important; }

  /* â”€â”€â”€ CARDS â”€â”€â”€ */
  .card {
    background: var(--bg2);
    border: 1px solid var(--border);
    border-radius: 14px;
    padding: 20px;
  }
  .card-title {
    font-size: 11px;
    text-transform: uppercase;
    letter-spacing: 0.12em;
    color: var(--muted);
    margin-bottom: 14px;
    font-weight: 600;
  }

  /* â”€â”€â”€ STAT CARDS â”€â”€â”€ */
  .stats-grid {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
    gap: 14px;
    margin-bottom: 24px;
  }
  .stat-card {
    background: var(--bg2);
    border: 1px solid var(--border);
    border-radius: 12px;
    padding: 18px 16px;
    position: relative;
    overflow: hidden;
  }
  .stat-card::before {
    content: '';
    position: absolute;
    top: 0; left: 0; right: 0;
    height: 2px;
  }
  .stat-card.c-accent::before { background: var(--accent); }
  .stat-card.c-green::before  { background: var(--green); }
  .stat-card.c-red::before    { background: var(--red); }
  .stat-card.c-gold::before   { background: var(--gold); }
  .stat-icon { font-size: 22px; margin-bottom: 8px; }
  .stat-label { font-size: 10px; color: var(--muted); letter-spacing: 0.1em; text-transform: uppercase; }
  .stat-value {
    font-family: var(--font-display);
    font-size: 32px;
    font-weight: 800;
    line-height: 1;
    margin: 4px 0 2px;
  }
  .stat-card.c-accent .stat-value { color: var(--accent); }
  .stat-card.c-green  .stat-value { color: var(--green); }
  .stat-card.c-red    .stat-value { color: var(--red); }
  .stat-card.c-gold   .stat-value { color: var(--gold); }
  .stat-sub { font-size: 11px; color: var(--muted); }

  /* â”€â”€â”€ CHARTS ROW â”€â”€â”€ */
  .charts-row {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
    gap: 16px;
    margin-bottom: 24px;
  }

  /* â”€â”€â”€ PROGRESS BAR â”€â”€â”€ */
  .prog-wrap { background: var(--bg); border-radius: 4px; height: 7px; overflow: hidden; }
  .prog-bar  { height: 100%; border-radius: 4px; transition: width 0.5s ease; }

  /* â”€â”€â”€ MODAL â”€â”€â”€ */
  .overlay {
    position: fixed; inset: 0;
    background: rgba(0,0,0,0.72);
    display: none;
    align-items: center;
    justify-content: center;
    z-index: 1000;
    backdrop-filter: blur(6px);
    padding: 16px;
  }
  .overlay.open { display: flex; }
  .modal {
    background: var(--bg2);
    border: 1px solid var(--border);
    border-radius: 16px;
    padding: 28px;
    width: 100%;
    max-width: 480px;
    max-height: 90vh;
    overflow-y: auto;
    box-shadow: 0 0 60px rgba(0,212,255,0.12);
    animation: slideUp 0.2s ease;
  }
  .memo-row {
    flex: 0 0 100%;
    padding: 10px 12px;
    background: rgba(255,209,102,0.08);
    border-top: 1px solid rgba(255,209,102,0.2);
    font-size: 14px;
    color: var(--text);
    line-height: 1.6;
    white-space: pre-wrap;
    word-break: break-word;
  }
  .like-row {
    display: flex;
    align-items: center;
    gap: 6px;
    padding: 8px 12px 8px;
    border-top: 1px solid var(--border);
    flex-wrap: wrap;
  }
  .like-btn {
    display: flex;
    align-items: center;
    gap: 4px;
    background: var(--bg3);
    border: 1px solid var(--border);
    border-radius: 99px;
    padding: 4px 10px 4px 6px;
    cursor: pointer;
    transition: all 0.15s;
    color: var(--muted);
    font-size: 13px;
  }
  .like-btn:hover { border-color: var(--accent); color: var(--accent); background: rgba(0,212,255,0.08); }
  .like-btn.liked { border-color: #FFD166; background: rgba(255,209,102,0.12); }
  .like-btn.liked .like-thumb { filter: none; }
  .like-thumb { font-size: 14px; }
  .like-total {
    margin-left: 4px;
    font-size: 13px;
    font-weight: 700;
    color: #FFD166;
    background: rgba(255,209,102,0.12);
    border: 1px solid rgba(255,209,102,0.3);
    border-radius: 99px;
    padding: 3px 10px;
  }
  @keyframes slideUp {
    from { opacity: 0; transform: translateY(20px); }
    to   { opacity: 1; transform: translateY(0); }
  }
  .modal-title {
    font-family: var(--font-display);
    font-size: 22px;
    font-weight: 800;
    letter-spacing: 0.06em;
    margin-bottom: 22px;
    color: var(--accent);
  }
  .modal-footer {
    display: flex;
    gap: 10px;
    justify-content: flex-end;
    margin-top: 8px;
  }

  /* â”€â”€â”€ FORM â”€â”€â”€ */
  .field { margin-bottom: 14px; }
  .field label {
    display: block;
    font-size: 11px;
    color: var(--muted);
    text-transform: uppercase;
    letter-spacing: 0.09em;
    margin-bottom: 6px;
    font-weight: 600;
  }
  .field label .req { color: var(--red); margin-left: 3px; }
  .field input, .field select, .field textarea {
    width: 100%;
    background: var(--bg);
    border: 1px solid var(--border);
    border-radius: 8px;
    padding: 10px 13px;
    color: var(--text);
    font-size: 14px;
    font-family: var(--font-body);
    outline: none;
    transition: border-color 0.2s;
  }
  .field input:focus, .field select:focus, .field textarea:focus {
    border-color: var(--accent);
    box-shadow: 0 0 0 3px rgba(0,212,255,0.08);
  }
  .field textarea { resize: vertical; min-height: 70px; }
  .field select option { background: var(--bg2); }
  .row2 { display: grid; grid-template-columns: 1fr 1fr; gap: 12px; }

  /* â”€â”€â”€ CUSTOM DATE PICKER â”€â”€â”€ */
  .datepicker-wrap { position: relative; }
  .datepicker-input {
    width: 100%;
    background: var(--bg);
    border: 1px solid var(--border);
    border-radius: 8px;
    padding: 10px 40px 10px 13px;
    color: var(--text);
    font-size: 14px;
    font-family: var(--font-body);
    outline: none;
    cursor: pointer;
    transition: border-color 0.2s;
    user-select: none;
  }
  .datepicker-input:hover { border-color: var(--muted); }
  .datepicker-input.active { border-color: var(--accent); box-shadow: 0 0 0 3px rgba(0,212,255,0.08); }
  .datepicker-icon {
    position: absolute;
    right: 12px; top: 50%;
    transform: translateY(-50%);
    pointer-events: none;
    color: var(--muted);
    font-size: 16px;
  }
  .datepicker-cal {
    position: fixed;
    z-index: 9999;
    background: var(--bg3);
    border: 1px solid var(--accent);
    border-radius: 12px;
    padding: 16px;
    width: 280px;
    box-shadow: 0 8px 40px rgba(0,0,0,0.8), 0 0 20px rgba(0,212,255,0.15);
    display: none;
  }
  .datepicker-cal.open { display: block; animation: calDrop 0.15s ease; }
  @keyframes calDrop {
    from { opacity: 0; transform: translateY(-6px); }
    to   { opacity: 1; transform: translateY(0); }
  }
  .cal-header {
    display: flex;
    align-items: center;
    justify-content: space-between;
    margin-bottom: 12px;
  }
  .cal-nav {
    background: none;
    border: 1px solid var(--border);
    border-radius: 6px;
    color: var(--text);
    width: 28px; height: 28px;
    display: flex; align-items: center; justify-content: center;
    cursor: pointer;
    font-size: 13px;
    transition: all 0.15s;
  }
  .cal-nav:hover { border-color: var(--accent); color: var(--accent); }
  .cal-month-label {
    font-family: var(--font-display);
    font-size: 16px;
    font-weight: 800;
    letter-spacing: 0.06em;
    color: var(--accent);
    cursor: pointer;
  }
  .cal-month-label:hover { opacity: 0.8; }
  .cal-weekdays {
    display: grid;
    grid-template-columns: repeat(7, 1fr);
    margin-bottom: 6px;
  }
  .cal-wd {
    text-align: center;
    font-size: 10px;
    color: var(--muted);
    font-weight: 600;
    letter-spacing: 0.05em;
    padding: 3px 0;
  }
  .cal-wd:first-child { color: #FF6B6B; }
  .cal-wd:last-child  { color: #6BA4FF; }
  .cal-days {
    display: grid;
    grid-template-columns: repeat(7, 1fr);
    gap: 2px;
  }
  .cal-day {
    text-align: center;
    padding: 6px 2px;
    font-size: 13px;
    border-radius: 6px;
    cursor: pointer;
    transition: all 0.12s;
    color: var(--text);
    border: 1px solid transparent;
  }
  .cal-day:hover:not(.empty):not(.selected) {
    background: rgba(0,212,255,0.12);
    border-color: rgba(0,212,255,0.3);
  }
  .cal-day.other-month { color: var(--muted2); }
  .cal-day.today {
    color: var(--accent);
    font-weight: 700;
    border-color: rgba(0,212,255,0.35);
  }
  .cal-day.selected {
    background: var(--accent);
    color: #000;
    font-weight: 700;
  }
  .cal-day.empty { cursor: default; }
  .cal-day:nth-child(7n+1):not(.selected) { color: #FF8585; }
  .cal-day:nth-child(7n+1).other-month { color: #7A4444; }
  .cal-day:nth-child(7n):not(.selected) { color: #85A8FF; }
  .cal-day:nth-child(7n).other-month { color: #3A4A7A; }
  .cal-day.selected { color: #000 !important; }

  /* year/month select panel */
  .cal-ym-panel {
    display: none;
    grid-template-columns: 1fr 1fr;
    gap: 8px;
    margin-top: 8px;
  }
  .cal-ym-panel.open { display: grid; }
  .cal-ym-select {
    background: var(--bg);
    border: 1px solid var(--border);
    border-radius: 6px;
    padding: 6px 8px;
    color: var(--text);
    font-size: 13px;
    font-family: var(--font-body);
    outline: none;
    cursor: pointer;
    width: 100%;
  }
  .cal-ym-select:focus { border-color: var(--accent); }

  /* â”€â”€â”€ LIST ITEMS â”€â”€â”€ */
  .list { display: flex; flex-direction: column; gap: 10px; }
  .list-item {
    background: var(--bg2);
    border: 1px solid var(--border);
    border-radius: 10px;
    padding: 14px 16px 0;
    display: flex;
    align-items: center;
    gap: 14px;
    border-left: 3px solid var(--accent);
    animation: fadeIn 0.3s ease;
    flex-wrap: wrap;
  }
  .list-item > .list-item-icon,
  .list-item > .list-item-body,
  .list-item > .list-item-actions { margin-bottom: 14px; }
  .like-row { flex: 0 0 calc(100% + 32px); margin: 0 -16px; border-radius: 0 0 10px 10px; }
  @keyframes fadeIn { from { opacity: 0; transform: translateX(-6px); } to { opacity: 1; transform: translateX(0); } }
  .list-item-icon { font-size: 26px; flex-shrink: 0; }
  .list-item-body { flex: 1; min-width: 0; }
  .list-item-title { font-weight: 600; color: var(--text); margin-bottom: 3px; }
  .list-item-meta { font-size: 12px; color: var(--muted); }
  .list-item-actions { display: flex; gap: 8px; align-items: center; flex-shrink: 0; }

  /* â”€â”€â”€ BADGES â”€â”€â”€ */
  .badge {
    display: inline-block;
    padding: 2px 8px;
    border-radius: 4px;
    font-size: 11px;
    font-weight: 600;
    background: rgba(0,212,255,0.15);
    color: var(--accent);
    border: 1px solid rgba(0,212,255,0.3);
  }

  /* â”€â”€â”€ USER GRID â”€â”€â”€ */
  .user-grid {
    display: grid;
    grid-template-columns: repeat(auto-fill, minmax(260px, 1fr));
    gap: 16px;
  }
  .user-card {
    background: var(--bg2);
    border: 1px solid var(--border);
    border-radius: 12px;
    padding: 20px;
    border-top: 3px solid var(--accent);
    animation: fadeIn 0.3s ease;
  }
  .user-card-header {
    display: flex;
    justify-content: space-between;
    align-items: flex-start;
    margin-bottom: 14px;
  }
  .user-name { font-size: 17px; font-weight: 700; color: var(--text); }
  .user-sub  { font-size: 11px; color: var(--muted); margin-top: 2px; }
  .user-stats { display: grid; grid-template-columns: 1fr 1fr; gap: 8px; margin-bottom: 10px; }
  .user-stat {
    background: var(--bg);
    border-radius: 8px;
    padding: 10px;
    text-align: center;
  }
  .user-stat-val {
    font-family: var(--font-display);
    font-size: 22px;
    font-weight: 800;
    color: var(--accent);
  }
  .user-stat-label { font-size: 9px; color: var(--muted); text-transform: uppercase; letter-spacing: 0.08em; margin-top: 1px; }

  /* â”€â”€â”€ FILTER BAR â”€â”€â”€ */
  .filter-bar {
    display: flex;
    gap: 10px;
    margin-bottom: 18px;
    flex-wrap: wrap;
    align-items: center;
    justify-content: space-between;
  }
  .filter-bar select {
    background: var(--bg);
    border: 1px solid var(--border);
    border-radius: 8px;
    padding: 8px 12px;
    color: var(--text);
    font-size: 13px;
    font-family: var(--font-body);
    outline: none;
    cursor: pointer;
  }
  .filter-bar select:focus { border-color: var(--accent); }

  /* â”€â”€â”€ SECTION HEADER â”€â”€â”€ */
  .section-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 20px;
    flex-wrap: wrap;
    gap: 12px;
  }
  .section-heading {
    font-family: var(--font-display);
    font-size: 26px;
    font-weight: 900;
    letter-spacing: 0.06em;
    color: var(--text);
  }

  /* â”€â”€â”€ WEIGHT BIG NUM â”€â”€â”€ */
  .weight-big {
    font-family: var(--font-display);
    font-size: 28px;
    font-weight: 800;
    color: var(--green);
  }

  /* â”€â”€â”€ EMPTY STATE â”€â”€â”€ */
  .empty {
    text-align: center;
    padding: 60px 20px;
    color: var(--muted);
  }
  .empty-icon { font-size: 52px; margin-bottom: 14px; }
  .empty-text { font-size: 15px; }

  /* â”€â”€â”€ TYPE BARS â”€â”€â”€ */
  .type-bar-wrap { display: flex; flex-direction: column; gap: 9px; }
  .type-bar-row { display: flex; align-items: center; gap: 10px; }
  .type-bar-label { font-size: 12px; color: var(--muted); width: 110px; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
  .type-bar-track { flex: 1; background: var(--bg); border-radius: 4px; height: 7px; overflow: hidden; }
  .type-bar-fill  { height: 100%; border-radius: 4px; }
  .type-bar-count { font-size: 13px; font-weight: 700; color: var(--text); width: 20px; text-align: right; }

  /* â”€â”€â”€ USER WEIGHT CARDS â”€â”€â”€ */
  .weight-user-grid {
    display: grid;
    grid-template-columns: repeat(auto-fill, minmax(200px, 1fr));
    gap: 12px;
  }
  .weight-user-card {
    background: var(--bg);
    border-radius: 10px;
    padding: 14px;
    border-left: 3px solid var(--accent);
  }
  .weight-user-name { font-weight: 700; color: var(--text); margin-bottom: 8px; font-size: 14px; }

  /* â”€â”€â”€ DIFF TAG â”€â”€â”€ */
  .diff-pos { color: var(--red); font-weight: 700; }
  .diff-neg { color: var(--green); font-weight: 700; }
  .diff-zero { color: var(--green); font-weight: 700; }

  /* â”€â”€â”€ TOAST â”€â”€â”€ */
  .toast {
    position: fixed;
    bottom: 24px; left: 50%;
    transform: translateX(-50%) translateY(80px);
    background: var(--bg3);
    border: 1px solid var(--green);
    color: var(--green);
    padding: 11px 22px;
    border-radius: 8px;
    font-size: 13px;
    font-weight: 600;
    z-index: 2000;
    transition: transform 0.3s ease;
    white-space: nowrap;
  }
  .toast.show { transform: translateX(-50%) translateY(0); }

  @media (max-width: 600px) {
    .content { padding: 16px; }
    .header  { padding: 12px 16px; }
    .nav     { padding: 0 12px; }
    .nav-btn { padding: 11px 14px; font-size: 12px; }
    .stats-grid { grid-template-columns: 1fr 1fr; }
    .modal  { padding: 20px; }
  }
</style>
</head>
<body>
<!-- â•â•â•â•â•â•â•â•â•â•â•â•â•â• LOGIN SCREEN â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
<div id="loginScreen" style="display:flex; min-height:100vh; align-items:center; justify-content:center; padding:24px;">
  <div style="width:100%; max-width:400px;">
    <div style="text-align:center; margin-bottom:32px;">
      <div style="font-size:48px; margin-bottom:12px;">ğŸ‹ï¸</div>
      <div style="font-family:var(--font-display); font-size:32px; font-weight:900; letter-spacing:0.08em; color:var(--accent);">TRAINING TRACKER</div>
      <div style="font-size:12px; color:var(--muted); margin-top:4px;">ãƒˆãƒ¬ãƒ¼ãƒ‹ãƒ³ã‚° & ä½“é‡ç®¡ç†</div>
    </div>
    <div style="background:var(--bg2); border:1px solid var(--border); border-radius:16px; padding:28px; box-shadow:0 0 40px rgba(0,212,255,0.08);">
      <div style="display:flex; gap:0; margin-bottom:24px; background:var(--bg); border-radius:8px; padding:4px;">
        <button id="tabLogin" onclick="switchAuthTab('login')" style="flex:1; padding:8px; border:none; border-radius:6px; cursor:pointer; font-family:var(--font-body); font-size:13px; font-weight:600; background:var(--accent); color:#000; transition:all 0.2s;">ãƒ­ã‚°ã‚¤ãƒ³</button>
        <button id="tabSignup" onclick="switchAuthTab('signup')" style="flex:1; padding:8px; border:none; border-radius:6px; cursor:pointer; font-family:var(--font-body); font-size:13px; font-weight:600; background:transparent; color:var(--muted); transition:all 0.2s;">æ–°è¦ç™»éŒ²</button>
      </div>
      <div id="authError" style="display:none; background:rgba(255,77,106,0.12); border:1px solid rgba(255,77,106,0.3); border-radius:8px; padding:10px 12px; font-size:12px; color:var(--red); margin-bottom:16px;"></div>
      <div class="field">
        <label>ã‚µã‚¤ãƒˆID <span class="req">*</span></label>
        <input type="text" id="authEmail" placeholder="ä¾‹ï¼šmyteam@training.com" autocomplete="username">
      </div>
      <div class="field">
        <label>ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ <span class="req">*</span></label>
        <input type="password" id="authPassword" placeholder="6æ–‡å­—ä»¥ä¸Š">
      </div>
      <button id="authSubmitBtn" onclick="authSubmit()" style="width:100%; padding:12px; background:var(--accent); color:#000; border:none; border-radius:8px; font-family:var(--font-body); font-size:14px; font-weight:700; cursor:pointer; margin-top:8px;">ãƒ­ã‚°ã‚¤ãƒ³</button>
      <div id="authLoading" style="display:none; text-align:center; padding:12px; font-size:13px; color:var(--muted);">â³ å‡¦ç†ä¸­...</div>
    </div>
    <div style="text-align:center; margin-top:16px; font-size:11px; color:var(--muted2);">ã‚µã‚¤ãƒˆIDã¨ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ã‚’å…±æœ‰ã—ã¦ãƒãƒ¼ãƒ ã§ä½¿ãˆã¾ã™</div>
  </div>
</div>

<!-- â•â•â•â•â•â•â•â•â•â•â•â•â•â• APP SCREEN â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
<div id="appScreen" style="display:none;">


<!-- DRAWER OVERLAY -->
<div class="drawer-overlay" id="drawerOverlay" onclick="closeDrawer()"></div>

<!-- DRAWER -->
<div class="drawer" id="drawer">
  <div class="drawer-header">
    <div class="drawer-logo-icon">ğŸ†</div>
    <div>
      <div class="drawer-logo-title">TRAINING TRACKER</div>
      <div class="drawer-logo-sub">ãƒˆãƒ¬ãƒ¼ãƒ‹ãƒ³ã‚° & ä½“é‡ç®¡ç†</div>
    </div>
  </div>
  <nav class="drawer-nav">
    <button class="drawer-nav-btn active" data-tab="dashboard" onclick="switchTab(this)">
      <span class="nav-icon">ğŸ“Š</span> ãƒ€ãƒƒã‚·ãƒ¥ãƒœãƒ¼ãƒ‰
    </button>
    <button class="drawer-nav-btn" data-tab="users" onclick="switchTab(this)">
      <span class="nav-icon">ğŸ‘¥</span> ãƒ¦ãƒ¼ã‚¶ãƒ¼
    </button>
    <button class="drawer-nav-btn" data-tab="trainings" onclick="switchTab(this)">
      <span class="nav-icon">ğŸ’ª</span> ãƒˆãƒ¬ãƒ¼ãƒ‹ãƒ³ã‚°
    </button>
    <button class="drawer-nav-btn" data-tab="weights" onclick="switchTab(this)">
      <span class="nav-icon">âš–ï¸</span> ä½“é‡
    </button>
    <div style="padding: 12px 20px 4px;">
      <button class="drawer-logout-btn" onclick="signOut()">
        <span>ğŸšª</span> ãƒ­ã‚°ã‚¢ã‚¦ãƒˆ
      </button>
    </div>
  </nav>
</div>

<!-- HEADER -->
<header class="header">
  <div style="display:flex; align-items:center; gap:14px;">
    <button class="hamburger-btn" id="hamburgerBtn" onclick="toggleDrawer()">
      <span></span><span></span><span></span>
    </button>
    <div class="header-logo">
      <div class="logo-icon">ğŸ†</div>
      <div class="logo-text">
        <div class="logo-title">TRAINING TRACKER</div>
        <div class="logo-sub">ãƒˆãƒ¬ãƒ¼ãƒ‹ãƒ³ã‚° & ä½“é‡ç®¡ç†</div>
      </div>
    </div>
  </div>
  <div class="header-actions">
    <button class="btn btn-primary" id="btnAddTraining" disabled>ğŸ’ª è¨˜éŒ²</button>
    <button class="btn btn-success" id="btnAddWeight" disabled>âš–ï¸ ä½“é‡</button>
  </div>
</header>

<!-- NAVï¼ˆæ—§navãƒ»éè¡¨ç¤ºï¼‰ -->
<nav class="nav">
  <button class="nav-btn active" data-tab="dashboard">ğŸ“Š ãƒ€ãƒƒã‚·ãƒ¥ãƒœãƒ¼ãƒ‰</button>
  <button class="nav-btn" data-tab="users">ğŸ‘¥ ãƒ¦ãƒ¼ã‚¶ãƒ¼</button>
  <button class="nav-btn" data-tab="trainings">ğŸ’ª ãƒˆãƒ¬ãƒ¼ãƒ‹ãƒ³ã‚°</button>
  <button class="nav-btn" data-tab="weights">âš–ï¸ ä½“é‡</button>
</nav>

<div class="content">

  <!-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• DASHBOARD â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
  <section id="sec-dashboard" class="section active">
    <div class="stats-grid" id="statsGrid"></div>

    <!-- æœˆã‚»ãƒ¬ã‚¯ã‚¿ãƒ¼ï¼ˆå…±é€šï¼‰ -->
    <div style="display:flex;justify-content:flex-end;margin-bottom:12px;">
      <select id="dashMonthSelect" onchange="renderDashboard()" style="background:var(--bg3);border:1px solid var(--border);color:var(--text);padding:6px 14px;border-radius:8px;font-family:var(--font-body);font-size:13px;cursor:pointer;"></select>
    </div>

    <!-- Row1: ãƒˆãƒ¬ãƒ¼ãƒ‹ãƒ³ã‚°å›æ•° + æ¶ˆè²»ã‚«ãƒ­ãƒªãƒ¼ -->
    <div class="dash-row2" style="margin-bottom:20px;">
      <div class="card">
        <div class="card-title">ğŸ’ª æœˆåˆ¥ãƒˆãƒ¬ãƒ¼ãƒ‹ãƒ³ã‚°å›æ•°</div>
        <div id="dashTrainBars"><div class="empty" style="padding:16px 0;color:var(--muted);">ãƒ‡ãƒ¼ã‚¿ãŒã‚ã‚Šã¾ã›ã‚“</div></div>
      </div>
      <div class="card">
        <div class="card-title">ğŸ”¥ æœˆåˆ¥æ¶ˆè²»ã‚«ãƒ­ãƒªãƒ¼</div>
        <div id="dashCalBars"><div class="empty" style="padding:16px 0;color:var(--muted);">ãƒ‡ãƒ¼ã‚¿ãŒã‚ã‚Šã¾ã›ã‚“</div></div>
      </div>
    </div>

    <!-- Row2: ä½“é‡æ¨ç§» + æœ€æ–°ãƒˆãƒ¬ãƒ¼ãƒ‹ãƒ³ã‚° -->
    <div class="dash-row2" style="margin-bottom:20px;">
      <div class="card">
        <div class="card-title">ğŸ“‰ å½“æœˆã®ä½“é‡æ¨ç§»</div>
        <canvas id="dashWeightChart" height="200"></canvas>
        <div id="dashWeightEmpty" class="empty" style="display:none;padding:30px 10px;color:var(--muted);">ãƒ‡ãƒ¼ã‚¿ãŒã‚ã‚Šã¾ã›ã‚“</div>
      </div>
      <div class="card">
        <div class="card-title">ğŸƒ æœ€æ–°ãƒˆãƒ¬ãƒ¼ãƒ‹ãƒ³ã‚°</div>
        <div id="dashLatestTrainings"><div class="empty" style="padding:16px 0;color:var(--muted);">ãƒ‡ãƒ¼ã‚¿ãŒã‚ã‚Šã¾ã›ã‚“</div></div>
      </div>
    </div>

    <!-- Row3: ç¨®åˆ¥å†…è¨³ + ä½“é‡é€²æ— -->
    <div class="charts-row">
      <div class="card">
        <div class="card-title">ğŸ¯ ç¨®åˆ¥å†…è¨³</div>
        <div class="type-bar-wrap" id="typeBars">
          <div class="empty" style="padding:20px 10px;color:var(--muted);">ãƒ‡ãƒ¼ã‚¿ãŒã‚ã‚Šã¾ã›ã‚“</div>
        </div>
      </div>
      <div class="card">
        <div class="card-title">âš–ï¸ ãƒ¦ãƒ¼ã‚¶ãƒ¼åˆ¥ ä½“é‡é€²æ—</div>
        <div class="weight-user-grid" id="weightUserGrid">
          <div class="empty" style="padding:20px;color:var(--muted);">ãƒ¦ãƒ¼ã‚¶ãƒ¼ã‚’ç™»éŒ²ã—ã¦ãã ã•ã„</div>
        </div>
      </div>
    </div>
  </section>

  <!-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• USERS â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
  <section id="sec-users" class="section">
    <div class="section-header">
      <span class="section-heading">ãƒ¦ãƒ¼ã‚¶ãƒ¼ç®¡ç†</span>
      <button class="btn btn-primary" onclick="openModal('modalUser')">+ ãƒ¦ãƒ¼ã‚¶ãƒ¼è¿½åŠ </button>
    </div>
    <div id="userGrid" class="user-grid"></div>
  </section>

  <!-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• TRAININGS â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
  <section id="sec-trainings" class="section">
    <div class="section-header">
      <span class="section-heading">ãƒˆãƒ¬ãƒ¼ãƒ‹ãƒ³ã‚°è¨˜éŒ²</span>
    </div>
    <div class="filter-bar">
      <div style="display:flex;gap:10px;flex-wrap:wrap;">
        <select id="filterTrainUser" onchange="renderTrainings()">
          <option value="all">ğŸ‘¥ å…¨å“¡</option>
        </select>
        <select id="filterTrainType" onchange="renderTrainings()">
          <option value="all">ğŸƒ å…¨ç¨®åˆ¥</option>
        </select>
      </div>
      <button class="btn btn-primary" id="btnAddTraining2" disabled onclick="openModal('modalTraining')">+ è¨˜éŒ²è¿½åŠ </button>
    </div>
    <div id="trainingList" class="list"></div>
  </section>

  <!-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• WEIGHTS â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
  <section id="sec-weights" class="section">
    <div class="section-header">
      <span class="section-heading">ä½“é‡è¨˜éŒ²</span>
    </div>
    <div class="filter-bar">
      <select id="filterWeightUser" onchange="renderWeights()">
        <option value="all">ğŸ‘¥ å…¨å“¡</option>
      </select>
      <div style="display:flex;gap:10px;">
        <button class="btn" style="background:rgba(0,212,255,0.12);color:var(--accent);border:1px solid rgba(0,212,255,0.3);" onclick="openModal('modalCsvImport')">ğŸ“‚ CSVã‚¤ãƒ³ãƒãƒ¼ãƒˆ</button>
        <button class="btn btn-success" id="btnAddWeight2" disabled onclick="openModal('modalWeight')">+ è¨˜éŒ²è¿½åŠ </button>
      </div>
    </div>
    <div id="weightChartWrap" class="card" style="margin-bottom:20px; display:none;">
      <div class="card-title" id="weightChartTitle">ä½“é‡æ¨ç§»</div>
      <canvas id="chartWeight" height="160"></canvas>
    </div>
    <div id="weightList" class="list"></div>
  </section>

</div><!-- /content -->

<!-- â•â•â•â•â•â•â•â•â•â•â•â•â•â• MODALS â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->

<!-- User Modal -->
<div class="overlay" id="modalUser" onclick="overlayClose(event, 'modalUser')">
  <div class="modal">
    <div class="modal-title">ğŸ‘¤ ãƒ¦ãƒ¼ã‚¶ãƒ¼ç™»éŒ²</div>
    <div class="field" style="text-align:center;">
      <div id="u_icon_preview" onclick="document.getElementById('u_icon_input').click()" style="width:80px;height:80px;border-radius:50%;background:var(--bg3);border:2px dashed var(--border);display:flex;align-items:center;justify-content:center;margin:0 auto 8px;cursor:pointer;overflow:hidden;font-size:32px;">ğŸ‘¤</div>
      <div style="font-size:11px;color:var(--muted);">ã‚¿ãƒƒãƒ—ã—ã¦å†™çœŸã‚’é¸æŠ</div>
      <input type="file" id="u_icon_input" accept="image/*" style="display:none;" onchange="previewIcon('u_icon_preview', this)">
    </div>
    <div class="field">
      <label>åå‰ <span class="req">*</span></label>
      <input type="text" id="u_name" placeholder="ä¾‹ï¼šç”°ä¸­ å¤ªéƒ">
    </div>
    <div class="row2">
      <div class="field">
        <label>èº«é•· (cm)</label>
        <input type="number" id="u_height" placeholder="170">
      </div>
      <div class="field">
        <label>ç›®æ¨™ä½“é‡ (kg)</label>
        <input type="number" id="u_target" placeholder="65.0" step="0.1">
      </div>
    </div>
    <div class="modal-footer">
      <button class="btn btn-ghost" onclick="closeModal('modalUser')">ã‚­ãƒ£ãƒ³ã‚»ãƒ«</button>
      <button class="btn btn-primary" onclick="saveUser()">ç™»éŒ²</button>
    </div>
  </div>
</div>

<!-- Edit User Modal -->
<div class="overlay" id="modalEditUser" onclick="overlayClose(event, 'modalEditUser')">
  <div class="modal">
    <div class="modal-title" style="color:var(--gold);">âœï¸ ãƒ¦ãƒ¼ã‚¶ãƒ¼ç·¨é›†</div>
    <input type="hidden" id="eu_id">
    <div class="field" style="text-align:center;">
      <div id="eu_icon_preview" onclick="document.getElementById('eu_icon_input').click()" style="width:80px;height:80px;border-radius:50%;background:var(--bg3);border:2px dashed var(--border);display:flex;align-items:center;justify-content:center;margin:0 auto 8px;cursor:pointer;overflow:hidden;font-size:32px;">ğŸ‘¤</div>
      <div style="font-size:11px;color:var(--muted);">ã‚¿ãƒƒãƒ—ã—ã¦å†™çœŸã‚’å¤‰æ›´</div>
      <input type="file" id="eu_icon_input" accept="image/*" style="display:none;" onchange="previewIcon('eu_icon_preview', this)">
    </div>
    <div class="field">
      <label>åå‰ <span class="req">*</span></label>
      <input type="text" id="eu_name">
    </div>
    <div class="row2">
      <div class="field">
        <label>èº«é•· (cm)</label>
        <input type="number" id="eu_height">
      </div>
      <div class="field">
        <label>ç›®æ¨™ä½“é‡ (kg)</label>
        <input type="number" id="eu_target" step="0.1">
      </div>
    </div>
    <div class="modal-footer">
      <button class="btn btn-ghost" onclick="closeModal('modalEditUser')">ã‚­ãƒ£ãƒ³ã‚»ãƒ«</button>
      <button class="btn btn-primary" onclick="updateUser()">ä¿å­˜</button>
    </div>
  </div>
</div>

<!-- Training Modal -->
<div class="overlay" id="modalTraining" onclick="overlayClose(event, 'modalTraining')">
  <div class="modal">
    <div class="modal-title">ğŸ’ª ãƒˆãƒ¬ãƒ¼ãƒ‹ãƒ³ã‚°è¨˜éŒ²</div>
    <div class="field">
      <label>ãƒ¦ãƒ¼ã‚¶ãƒ¼ <span class="req">*</span></label>
      <select id="t_user"></select>
    </div>
    <div class="field">
      <label>ç¨®åˆ¥ <span class="req">*</span></label>
      <select id="t_type"></select>
    </div>
    <div class="field">
      <label>å ´æ‰€ãƒ»æ–½è¨­å</label>
      <input type="text" id="t_location" placeholder="ä¾‹ï¼šã‚´ãƒ¼ãƒ«ãƒ‰ã‚¸ãƒ æ¸‹è°·ã€ä»£ã€…æœ¨å…¬åœ’">
    </div>
    <div class="field">
      <label>ä½æ‰€ãƒ»ã‚¨ãƒªã‚¢</label>
      <input type="text" id="t_address" placeholder="ä¾‹ï¼šæ±äº¬éƒ½æ¸‹è°·åŒº">
    </div>
    <div class="row2">
      <div class="field">
        <label>æ—¥ä»˜ <span class="req">*</span></label>
        <div class="datepicker-wrap" id="dp_t_wrap">
          <div class="datepicker-input" id="dp_t_display" onclick="dpToggle('dp_t')">æ—¥ä»˜ã‚’é¸æŠ</div>
          <span class="datepicker-icon">ğŸ“…</span>
          <input type="hidden" id="t_date">
          <!-- calendar portal: dp_t -->
        </div>
      </div>
      <div class="field">
        <label>æ™‚é–“ (åˆ†)</label>
        <input type="number" id="t_duration" placeholder="60">
      </div>
    </div>
    <div class="row2">
      <div class="field">
        <label>æ¶ˆè²»ã‚«ãƒ­ãƒªãƒ¼ (kcal)</label>
        <input type="number" id="t_cal" placeholder="300">
      </div>
      <div class="field">
        <label>ä½“é‡ (kg)</label>
        <input type="number" id="t_weight" placeholder="70.5" step="0.1">
      </div>
    </div>
    <div class="field">
      <label>ãƒ¡ãƒ¢</label>
      <textarea id="t_memo" placeholder="ä»Šæ—¥ã®ãƒˆãƒ¬ãƒ¼ãƒ‹ãƒ³ã‚°ãƒ¡ãƒ¢â€¦"></textarea>
    </div>
    <div class="modal-footer">
      <button class="btn btn-ghost" onclick="closeModal('modalTraining')">ã‚­ãƒ£ãƒ³ã‚»ãƒ«</button>
      <button class="btn btn-primary" onclick="saveTraining()">è¨˜éŒ²ã™ã‚‹</button>
    </div>
  </div>
</div>

<!-- Weight Modal -->
<div class="overlay" id="modalWeight" onclick="overlayClose(event, 'modalWeight')">
  <div class="modal">
    <div class="modal-title" style="color:var(--green);">âš–ï¸ ä½“é‡è¨˜éŒ²</div>
    <div class="field">
      <label>ãƒ¦ãƒ¼ã‚¶ãƒ¼ <span class="req">*</span></label>
      <select id="w_user"></select>
    </div>
    <div class="row2">
      <div class="field">
        <label>ä½“é‡ (kg) <span class="req">*</span></label>
        <input type="number" id="w_weight" placeholder="70.5" step="0.1">
      </div>
      <div class="field">
        <label>ä½“è„‚è‚ªç‡ (%)</label>
        <input type="number" id="w_fat" placeholder="18.5" step="0.1">
      </div>
    </div>
    <div class="field">
      <label>è¨ˆæ¸¬æ—¥ <span class="req">*</span></label>
      <div class="datepicker-wrap" id="dp_w_wrap">
        <div class="datepicker-input" id="dp_w_display" onclick="dpToggle('dp_w')">æ—¥ä»˜ã‚’é¸æŠ</div>
        <span class="datepicker-icon">ğŸ“…</span>
        <input type="hidden" id="w_date">
        <!-- calendar portal: dp_w -->
      </div>
    </div>
    <div class="field">
      <label>ãƒ¡ãƒ¢</label>
      <input type="text" id="w_memo" placeholder="ä½“èª¿ãªã©">
    </div>
    <div class="modal-footer">
      <button class="btn btn-ghost" onclick="closeModal('modalWeight')">ã‚­ãƒ£ãƒ³ã‚»ãƒ«</button>
      <button class="btn btn-success" onclick="saveWeight()">è¨˜éŒ²ã™ã‚‹</button>
    </div>
  </div>
</div>



<!-- CSV Import Modal -->
<div class="overlay" id="modalCsvImport" onclick="overlayClose(event, 'modalCsvImport')">
  <div class="modal" style="max-width:540px;">
    <div class="modal-title" style="color:var(--accent);">ğŸ“‚ CSV ä½“é‡ã‚¤ãƒ³ãƒãƒ¼ãƒˆ</div>

    <!-- Step1: ãƒ•ã‚¡ã‚¤ãƒ«é¸æŠ -->
    <div id="csvStep1">
      <div class="field">
        <label>å¯¾è±¡ãƒ¦ãƒ¼ã‚¶ãƒ¼ <span class="req">*</span></label>
        <select id="csv_user"></select>
      </div>
      <div class="field">
        <label>CSVãƒ•ã‚¡ã‚¤ãƒ«ã‚’é¸æŠ</label>
        <div id="csvDropZone" style="border:2px dashed var(--border);border-radius:10px;padding:30px;text-align:center;cursor:pointer;transition:border-color 0.2s;color:var(--muted);">
          <div style="font-size:32px;margin-bottom:8px;">ğŸ“„</div>
          <div style="font-size:13px;">ã‚¯ãƒªãƒƒã‚¯ã¾ãŸã¯ãƒ‰ãƒ©ãƒƒã‚°ï¼†ãƒ‰ãƒ­ãƒƒãƒ—</div>
          <div style="font-size:11px;margin-top:4px;color:var(--muted2);">.csv ãƒ•ã‚¡ã‚¤ãƒ«å¯¾å¿œï¼ˆæ–‡å­—ã‚³ãƒ¼ãƒ‰: UTF-8 / Shift-JISï¼‰</div>
          <input type="file" id="csvFileInput" accept=".csv" style="display:none;">
        </div>
      </div>
      <div style="background:var(--bg);border-radius:8px;padding:12px;font-size:12px;color:var(--muted);line-height:1.8;">
        <div style="color:var(--text);font-weight:600;margin-bottom:6px;">ğŸ“‹ å¯¾å¿œãƒ•ã‚©ãƒ¼ãƒãƒƒãƒˆä¾‹</div>
        <div>æ—¥ä»˜,ä½“é‡,ä½“è„‚è‚ªç‡</div>
        <div>2026/01/01,70.5,18.2</div>
        <div style="margin-top:4px;color:var(--muted2);">â€»ãƒ˜ãƒƒãƒ€ãƒ¼è¡Œã¯è‡ªå‹•åˆ¤å®šã€‚æ—¥ä»˜ã¯ YYYY/MM/DDãƒ»YYYY-MM-DDãƒ»MM/DD å½¢å¼ã«å¯¾å¿œã€‚</div>
      </div>
    </div>

    <!-- Step2: åˆ—ãƒãƒƒãƒ”ãƒ³ã‚°ç¢ºèª -->
    <div id="csvStep2" style="display:none;">
      <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:12px;">
        <div style="font-size:13px;color:var(--text);font-weight:600;">åˆ—ã®å‰²ã‚Šå½“ã¦ã‚’ç¢ºèªã—ã¦ãã ã•ã„</div>
        <div id="csvRowCount" style="font-size:11px;color:var(--muted);"></div>
      </div>
      <div class="row2" style="margin-bottom:12px;">
        <div class="field" style="margin-bottom:0">
          <label>æ—¥ä»˜ã®åˆ—</label>
          <select id="csv_col_date"></select>
        </div>
        <div class="field" style="margin-bottom:0">
          <label>ä½“é‡ (kg) ã®åˆ—</label>
          <select id="csv_col_weight"></select>
        </div>
      </div>
      <div class="row2" style="margin-bottom:16px;">
        <div class="field" style="margin-bottom:0">
          <label>ä½“è„‚è‚ªç‡ (%) ã®åˆ— <span style="color:var(--muted);font-size:10px;">ä»»æ„</span></label>
          <select id="csv_col_fat"></select>
        </div>
        <div class="field" style="margin-bottom:0"></div>
      </div>
      <!-- ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼ -->
      <div style="font-size:11px;color:var(--muted);margin-bottom:6px;">ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼ï¼ˆå…ˆé ­3ä»¶ï¼‰</div>
      <div id="csvPreview" style="background:var(--bg);border-radius:8px;padding:10px;font-size:12px;font-family:monospace;color:var(--text);line-height:1.8;max-height:100px;overflow-y:auto;"></div>
      <div id="csvImportInfo" style="margin-top:10px;font-size:12px;color:var(--muted);"></div>
    </div>

    <div class="modal-footer" style="margin-top:16px;">
      <button class="btn btn-ghost" onclick="closeModal('modalCsvImport');csvReset();">ã‚­ãƒ£ãƒ³ã‚»ãƒ«</button>
      <button class="btn btn-primary" id="csvNextBtn" onclick="csvNext()" style="display:none;">æ¬¡ã¸ â†’</button>
      <button class="btn btn-primary" id="csvImportBtn" onclick="csvImport()" style="display:none;">ã‚¤ãƒ³ãƒãƒ¼ãƒˆ</button>
    </div>
  </div>
</div>

<!-- Edit Weight Modal -->
<div class="overlay" id="modalEditWeight" onclick="overlayClose(event, 'modalEditWeight')">
  <div class="modal">
    <div class="modal-title" style="color:var(--gold);">âœï¸ ä½“é‡è¨˜éŒ² ç·¨é›†</div>
    <input type="hidden" id="ew_id">
    <div class="field">
      <label>ãƒ¦ãƒ¼ã‚¶ãƒ¼ <span class="req">*</span></label>
      <select id="ew_user"></select>
    </div>
    <div class="row2">
      <div class="field">
        <label>ä½“é‡ (kg) <span class="req">*</span></label>
        <input type="number" id="ew_weight" placeholder="70.5" step="0.1">
      </div>
      <div class="field">
        <label>ä½“è„‚è‚ªç‡ (%)</label>
        <input type="number" id="ew_fat" placeholder="18.5" step="0.1">
      </div>
    </div>
    <div class="field">
      <label>è¨ˆæ¸¬æ—¥ <span class="req">*</span></label>
      <div class="datepicker-wrap" id="dp_ew_wrap">
        <div class="datepicker-input" id="dp_ew_display" onclick="dpToggle('dp_ew')">æ—¥ä»˜ã‚’é¸æŠ</div>
        <span class="datepicker-icon">ğŸ“…</span>
        <input type="hidden" id="ew_date">
      </div>
    </div>
    <div class="field">
      <label>ãƒ¡ãƒ¢</label>
      <input type="text" id="ew_memo" placeholder="ä½“èª¿ãªã©">
    </div>
    <div class="modal-footer">
      <button class="btn btn-ghost" onclick="closeModal('modalEditWeight')">ã‚­ãƒ£ãƒ³ã‚»ãƒ«</button>
      <button class="btn btn-primary" onclick="updateWeight()">ä¿å­˜</button>
    </div>
  </div>
</div>

<!-- Edit Training Modal -->
<div class="overlay" id="modalEditTraining" onclick="overlayClose(event, 'modalEditTraining')">
  <div class="modal">
    <div class="modal-title" style="color:var(--gold);">âœï¸ ãƒˆãƒ¬ãƒ¼ãƒ‹ãƒ³ã‚° ç·¨é›†</div>
    <input type="hidden" id="et_id">
    <div class="field">
      <label>ãƒ¦ãƒ¼ã‚¶ãƒ¼ <span class="req">*</span></label>
      <select id="et_user"></select>
    </div>
    <div class="field">
      <label>ç¨®åˆ¥ <span class="req">*</span></label>
      <select id="et_type"></select>
    </div>
    <div class="field">
      <label>å ´æ‰€ãƒ»æ–½è¨­å</label>
      <input type="text" id="et_location" placeholder="ä¾‹ï¼šã‚´ãƒ¼ãƒ«ãƒ‰ã‚¸ãƒ æ¸‹è°·">
    </div>
    <div class="field">
      <label>ä½æ‰€ãƒ»ã‚¨ãƒªã‚¢</label>
      <input type="text" id="et_address" placeholder="ä¾‹ï¼šæ±äº¬éƒ½æ¸‹è°·åŒº">
    </div>
    <div class="row2">
      <div class="field">
        <label>æ—¥ä»˜ <span class="req">*</span></label>
        <div class="datepicker-wrap" id="dp_et_wrap">
          <div class="datepicker-input" id="dp_et_display" onclick="dpToggle('dp_et')">æ—¥ä»˜ã‚’é¸æŠ</div>
          <span class="datepicker-icon">ğŸ“…</span>
          <input type="hidden" id="et_date">
        </div>
      </div>
      <div class="field">
        <label>æ™‚é–“ (åˆ†)</label>
        <input type="number" id="et_duration" placeholder="60">
      </div>
    </div>
    <div class="row2">
      <div class="field">
        <label>æ¶ˆè²»ã‚«ãƒ­ãƒªãƒ¼ (kcal)</label>
        <input type="number" id="et_cal" placeholder="300">
      </div>
      <div class="field">
        <label>ä½“é‡ (kg)</label>
        <input type="number" id="et_weight" placeholder="70.5" step="0.1">
      </div>
    </div>
    <div class="field">
      <label>ãƒ¡ãƒ¢</label>
      <textarea id="et_memo" placeholder="ãƒ¡ãƒ¢â€¦"></textarea>
    </div>
    <div class="modal-footer">
      <button class="btn btn-ghost" onclick="closeModal('modalEditTraining')">ã‚­ãƒ£ãƒ³ã‚»ãƒ«</button>
      <button class="btn btn-primary" onclick="updateTraining()">ä¿å­˜</button>
    </div>
  </div>
</div>

<!-- â”€â”€ ã‚«ãƒ¬ãƒ³ãƒ€ãƒ¼ãƒãƒ¼ã‚¿ãƒ«ï¼ˆbodyç›´ä¸‹ã€z-indexæœ€ä¸Šä½ï¼‰ â”€â”€ -->
<div class="datepicker-cal" id="dp_t_cal"></div>
<div class="datepicker-cal" id="dp_w_cal"></div>
<div class="datepicker-cal" id="dp_ew_cal"></div>
<div class="datepicker-cal" id="dp_et_cal"></div>

<!-- TOAST -->
<div class="toast" id="toast"></div>

<script>
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  HELPERS
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
const uid      = () => Math.random().toString(36).slice(2) + Date.now().toString(36);
const now      = () => new Date().toISOString();
const today    = () => { const d = new Date(); d.setTime(d.getTime() + 9*60*60*1000); return d.toISOString().split('T')[0]; };
const esc      = s => String(s||'').replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;');
const getUser  = id => db.users.find(u => u.id === id);
const getType  = id => TRAINING_TYPES.find(t => t.id === id);
const userColor= id => { const i = db.users.findIndex(u => u.id === id); return USER_COLORS[i % USER_COLORS.length]; };

function showToast(msg) {
  const t = document.getElementById('toast');
  t.textContent = msg;
  t.classList.add('show');
  setTimeout(() => t.classList.remove('show'), 2500);
}
function openModal(id)  { document.getElementById(id).classList.add('open'); }
function closeModal(id) { document.getElementById(id).classList.remove('open'); }
function overlayClose(e, id) { if (e.target.classList.contains('overlay')) closeModal(id); }

// â”€â”€ ã‚¢ã‚¤ã‚³ãƒ³é–¢é€£ï¼ˆSupabase Storageï¼‰ â”€â”€
const AVATAR_BUCKET = 'avatars';

// ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼è¡¨ç¤ºï¼ˆãƒ•ã‚¡ã‚¤ãƒ«ã‚’inputã‹ã‚‰èª­ã¿è¾¼ã¿ï¼‰
function previewIcon(previewId, input) {
  const file = input.files[0];
  if (!file) return;
  const reader = new FileReader();
  reader.onload = e => {
    const el = document.getElementById(previewId);
    el.innerHTML = '';
    el.style.padding = '0';
    const img = document.createElement('img');
    img.src = e.target.result;
    img.style.cssText = 'width:100%;height:100%;object-fit:cover;';
    el.appendChild(img);
    el.dataset.file = 'pending'; // ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰å¾…ã¡
    el._pendingFile = file;      // Fileã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆã‚’ä¿æŒ
  };
  reader.readAsDataURL(file);
}

// Supabase Storageã«ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ã—ã¦URLã‚’è¿”ã™
async function uploadAvatar(userId, file) {
  const ext = file.name.split('.').pop() || 'jpg';
  const path = `${userId}.${ext}`;
  const res = await fetch(`${SUPABASE_URL}/storage/v1/object/${AVATAR_BUCKET}/${path}`, {
    method: 'POST',
    headers: {
      'Authorization': `Bearer ${accessToken}`,
      'Content-Type': file.type || 'image/jpeg',
      'x-upsert': 'true'
    },
    body: file
  });
  if (!res.ok) {
    const txt = await res.text();
    throw new Error('ã‚¢ãƒã‚¿ãƒ¼ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰å¤±æ•—: ' + txt);
  }
  return `${SUPABASE_URL}/storage/v1/object/public/${AVATAR_BUCKET}/${path}?t=${Date.now()}`;
}

// ã‚¢ã‚¤ã‚³ãƒ³URLã‚’localStorageã«ã‚­ãƒ£ãƒƒã‚·ãƒ¥
function cacheIconUrl(userId, url) {
  try { localStorage.setItem('icon_url_' + userId, url); } catch(e) {}
}
function getCachedIconUrl(userId) {
  try { return localStorage.getItem('icon_url_' + userId); } catch(e) { return null; }
}

// ã‚¢ã‚¤ã‚³ãƒ³HTMLç”Ÿæˆï¼ˆã‚­ãƒ£ãƒƒã‚·ãƒ¥URLã‚’ä½¿ç”¨ï¼‰
function getIconHtml(userId, size=40) {
  const url = getCachedIconUrl(userId);
  if (url) {
    return `<img src="${url}" style="width:${size}px;height:${size}px;border-radius:50%;object-fit:cover;" onerror="this.parentElement.innerHTML='<div style=\'width:${size}px;height:${size}px;border-radius:50%;background:var(--bg3);display:flex;align-items:center;justify-content:center;font-size:${Math.floor(size*0.5)}px;\'>ğŸ‘¤</div>'">`;
  }
  return `<div style="width:${size}px;height:${size}px;border-radius:50%;background:var(--bg3);display:flex;align-items:center;justify-content:center;font-size:${Math.floor(size*0.5)}px;">ğŸ‘¤</div>`;
}

// å…¨ãƒ¦ãƒ¼ã‚¶ãƒ¼ã®ã‚¢ãƒã‚¿ãƒ¼URLã‚’Supabaseã‹ã‚‰å–å¾—ã—ã¦ã‚­ãƒ£ãƒƒã‚·ãƒ¥
async function refreshAvatarCache() {
  if (!db.users.length) return;
  for (const u of db.users) {
    // jpg/png/webpã‚’è©¦ã™
    for (const ext of ['jpg','png','jpeg','webp']) {
      const url = `${SUPABASE_URL}/storage/v1/object/public/${AVATAR_BUCKET}/${u.id}.${ext}`;
      try {
        const res = await fetch(url, { method: 'HEAD' });
        if (res.ok) { cacheIconUrl(u.id, url + '?t=' + Date.now()); break; }
      } catch(e) {}
    }
  }
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  SUPABASE CONFIG
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
const SUPABASE_URL  = 'https://cgecaukugbjybeddvphg.supabase.co';
const SUPABASE_ANON = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImNnZWNhdWt1Z2JqeWJlZGR2cGhnIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NzEyOTU1MTksImV4cCI6MjA4Njg3MTUxOX0.JbzUxvwkWdy9kknkmcgDNSA7amJMpnzbntIPx3lkS8I';
const sb = supabase.createClient(SUPABASE_URL, SUPABASE_ANON);

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  DATA
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
const TRAINING_TYPES = [
  { id:'gym',        icon:'ğŸ‹ï¸', label:'ã‚¸ãƒ ' },
  { id:'run_out',    icon:'ğŸƒ', label:'å±‹å¤–ãƒ©ãƒ³ãƒ‹ãƒ³ã‚°' },
  { id:'run_in',     icon:'ğŸƒâ€â™€ï¸', label:'å±‹å†…ãƒ©ãƒ³ãƒ‹ãƒ³ã‚°' },
  { id:'swim',       icon:'ğŸŠ', label:'æ°´æ³³' },
  { id:'cycle',      icon:'ğŸš´', label:'è‡ªè»¢è»Š' },
  { id:'walk',       icon:'ğŸš¶', label:'å¾’æ­©' },
  { id:'yoga',       icon:'ğŸ§˜', label:'ãƒ¨ã‚¬' },
  { id:'tennis',     icon:'ğŸ¾', label:'ãƒ†ãƒ‹ã‚¹' },
  { id:'soccer',     icon:'âš½', label:'ã‚µãƒƒã‚«ãƒ¼' },
  { id:'other',      icon:'âš¡', label:'ãã®ä»–' },
];

const USER_COLORS = ['#00D4FF','#FF4D6A','#3DFF8F','#FFD166','#FF69B4','#B48EFF','#FF9F43','#26C6DA'];

// ã‚¤ãƒ³ãƒ¡ãƒ¢ãƒªDBï¼ˆSupabaseã‹ã‚‰èª­ã¿è¾¼ã‚“ã ãƒ‡ãƒ¼ã‚¿ã‚’ã‚­ãƒ£ãƒƒã‚·ãƒ¥ï¼‰
let db = { users:[], trainings:[], weights:[], likes:[] };
let currentUser = null; // ãƒ­ã‚°ã‚¤ãƒ³ä¸­ã®Supabaseãƒ¦ãƒ¼ã‚¶ãƒ¼
let accessToken = null;  // JWTãƒˆãƒ¼ã‚¯ãƒ³

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  AUTH
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function switchAuthTab(tab) {
  const isLogin = tab === 'login';
  document.getElementById('tabLogin').style.cssText   = isLogin ? 'flex:1;padding:8px;border:none;border-radius:6px;cursor:pointer;font-family:var(--font-body);font-size:13px;font-weight:600;background:var(--accent);color:#000;' : 'flex:1;padding:8px;border:none;border-radius:6px;cursor:pointer;font-family:var(--font-body);font-size:13px;font-weight:600;background:transparent;color:var(--muted);';
  document.getElementById('tabSignup').style.cssText  = !isLogin ? 'flex:1;padding:8px;border:none;border-radius:6px;cursor:pointer;font-family:var(--font-body);font-size:13px;font-weight:600;background:var(--accent);color:#000;' : 'flex:1;padding:8px;border:none;border-radius:6px;cursor:pointer;font-family:var(--font-body);font-size:13px;font-weight:600;background:transparent;color:var(--muted);';
  document.getElementById('authSubmitBtn').textContent = isLogin ? 'ãƒ­ã‚°ã‚¤ãƒ³' : 'æ–°è¦ç™»éŒ²ã™ã‚‹';
  document.getElementById('authError').style.display  = 'none';
}

function showAuthError(msg) {
  const el = document.getElementById('authError');
  el.textContent = msg; el.style.display = 'block';
}

async function authSubmit() {
  const email    = document.getElementById('authEmail').value.trim();
  const password = document.getElementById('authPassword').value;
  const isLogin  = document.getElementById('authSubmitBtn').textContent === 'ãƒ­ã‚°ã‚¤ãƒ³';

  if (!email || !password) { showAuthError('ã‚µã‚¤ãƒˆIDã¨ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„'); return; }

  document.getElementById('authLoading').style.display = 'block';
  document.getElementById('authSubmitBtn').style.display = 'none';
  document.getElementById('authError').style.display = 'none';

  try {
    if (isLogin) {
      const { data, error } = await sb.auth.signInWithPassword({ email, password });
      if (error) throw error;
    } else {
      const { data, error } = await sb.auth.signUp({ email, password });
      if (error) throw error;
      if (!data.session) {
        document.getElementById('authLoading').style.display = 'none';
        document.getElementById('authSubmitBtn').style.display = 'block';
        showAuthError('ç¢ºèªãƒ¡ãƒ¼ãƒ«ã‚’é€ä¿¡ã—ã¾ã—ãŸã€‚ãƒ¡ãƒ¼ãƒ«ã®ãƒªãƒ³ã‚¯ã‚’ã‚¯ãƒªãƒƒã‚¯ã—ã¦ãã ã•ã„ã€‚');
        return;
      }
    }
  } catch(e) {
    const msg = e.message || 'ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ';
    const jpMsg = msg.includes('Invalid login') ? 'ã‚µã‚¤ãƒˆIDã¾ãŸã¯ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ãŒé•ã„ã¾ã™'
                : msg.includes('already registered') ? 'ã“ã®ã‚µã‚¤ãƒˆIDã¯æ—¢ã«ç™»éŒ²ã•ã‚Œã¦ã„ã¾ã™'
                : msg.includes('Password should') ? 'ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ã¯6æ–‡å­—ä»¥ä¸Šã«ã—ã¦ãã ã•ã„'
                : msg;
    showAuthError(jpMsg);
    document.getElementById('authLoading').style.display = 'none';
    document.getElementById('authSubmitBtn').style.display = 'block';
  }
}

async function signOut() {
  try {
    await sb.auth.signOut();
    // å¿µã®ãŸã‚æ‰‹å‹•ã§ç”»é¢åˆ‡ã‚Šæ›¿ãˆ
    currentUser = null;
    accessToken = null;
    _lastUserId = null;
    db = { users:[], trainings:[], weights:[] };
    document.getElementById('loginScreen').style.display = 'flex';
    document.getElementById('appScreen').style.display   = 'none';
    closeDrawer();
  } catch(e) {
    alert('ãƒ­ã‚°ã‚¢ã‚¦ãƒˆã«å¤±æ•—ã—ã¾ã—ãŸ: ' + e.message);
  }
}

// èªè¨¼çŠ¶æ…‹ã®ç›£è¦–
let _lastUserId = null;
sb.auth.onAuthStateChange(async (event, session) => {
  if (session && session.user) {
    const uid = session.user.id;
    if (event === 'SIGNED_OUT') return;
    currentUser = session.user;
    accessToken = session.access_token;
    document.getElementById('loginScreen').style.display = 'none';
    document.getElementById('appScreen').style.display   = 'block';
    if (_lastUserId !== uid || event === 'SIGNED_IN') {
      _lastUserId = uid;

      await loadAllData();
      updateAll();
    }
  } else {
    _lastUserId = null;
    currentUser = null;
    accessToken = null;
    db = { users:[], trainings:[], weights:[] };
    document.getElementById('loginScreen').style.display = 'flex';
    document.getElementById('appScreen').style.display   = 'none';
  }
});



// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  SUPABASE DATA LAYER
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function getToken() {
  return accessToken;
}

async function sbFetch(path, method='GET', body=null) {
  const token = getToken();
  const opts = {
    method,
    headers: {
      'Content-Type': 'application/json',
      'apikey': SUPABASE_ANON,
      'Authorization': `Bearer ${token}`,
      'Prefer': 'return=minimal'
    }
  };
  if (body) opts.body = JSON.stringify(body);
  const res = await fetch(`${SUPABASE_URL}/rest/v1/${path}`, opts);
  if (!res.ok) {
    const txt = await res.text();
    throw new Error(txt || `HTTP ${res.status}`);
  }
  // GETã®ã¿JSONã‚’è¿”ã™ã€ãã‚Œä»¥å¤–ã¯ç©º
  if (method === 'GET') return res.json();
  return null;
}

async function loadAllData() {
  if (!currentUser) return;
  const oid = currentUser.id;
  try {
    const users = await sbFetch(`users?owner_id=eq.${oid}&order=created_at`);
    db.users = (users||[]).map(u => ({
      id: u.id, name: u.name, height: u.height,
      targetWeight: u.target_weight, createdAt: u.created_at
    }));

    const trainings = await sbFetch(`trainings?owner_id=eq.${oid}&order=date.desc`);
    db.trainings = (trainings||[]).map(t => ({
      id: t.id, userId: t.user_id, type: t.type, date: t.date,
      location: t.location, address: t.address, duration: t.duration,
      cal: t.cal, postWeight: t.post_weight, memo: t.memo, createdAt: t.created_at
    }));

    const weights = await sbFetch(`weights?owner_id=eq.${oid}&order=date.desc`);
    db.weights = (weights||[]).map(w => ({
      id: w.id, userId: w.user_id, weight: w.weight, date: w.date,
      fat: w.fat, memo: w.memo, createdAt: w.created_at
    }));

    const likes = await sbFetch(`likes?owner_id=eq.${oid}`);
    db.likes = (likes||[]).map(l => ({ id: l.id, trainingId: l.training_id, userId: l.user_id }));

    console.log('loadAllData:', { users: db.users.length, trainings: db.trainings.length, weights: db.weights.length, likes: db.likes.length });
    await refreshAvatarCache();
  } catch(e) {
    console.error('loadAllData failed:', e);
  }
}

async function sbSaveUser(name, height, targetWeight) {
  await sbFetch('users', 'POST', {
    owner_id: currentUser.id, name,
    height: height||null, target_weight: targetWeight||null
  });
  await loadAllData();
}

async function sbUpdateUser(id, name, height, targetWeight) {
  await sbFetch(`users?id=eq.${id}&owner_id=eq.${currentUser.id}`, 'PATCH',
    { name, height: height||null, target_weight: targetWeight||null });
  await loadAllData();
}

async function sbDeleteUser(id) {
  await sbFetch(`users?id=eq.${id}&owner_id=eq.${currentUser.id}`, 'DELETE');
  await loadAllData();
}

async function sbSaveTraining(data) {
  await sbFetch('trainings', 'POST', {
    owner_id: currentUser.id, user_id: data.userId, type: data.type, date: data.date,
    location: data.location||null, address: data.address||null,
    duration: data.duration||null, cal: data.cal||null,
    post_weight: data.postWeight||null, memo: data.memo||null
  });
}

async function sbUpdateTraining(id, data) {
  await sbFetch(`trainings?id=eq.${id}&owner_id=eq.${currentUser.id}`, 'PATCH', {
    user_id: data.userId, type: data.type, date: data.date,
    location: data.location||null, address: data.address||null,
    duration: data.duration||null, cal: data.cal||null,
    post_weight: data.postWeight||null, memo: data.memo||null
  });
}

async function sbDeleteTraining(id) {
  await sbFetch(`trainings?id=eq.${id}&owner_id=eq.${currentUser.id}`, 'DELETE');
}

async function sbSaveWeight(data) {
  await sbFetch('weights', 'POST', {
    owner_id: currentUser.id, user_id: data.userId, weight: data.weight, date: data.date,
    fat: data.fat||null, memo: data.memo||null
  });
}

async function sbUpdateWeight(id, data) {
  await sbFetch(`weights?id=eq.${id}&owner_id=eq.${currentUser.id}`, 'PATCH', {
    user_id: data.userId, weight: data.weight, date: data.date,
    fat: data.fat||null, memo: data.memo||null
  });
}

async function sbDeleteWeight(id) {
  await sbFetch(`weights?id=eq.${id}&owner_id=eq.${currentUser.id}`, 'DELETE');
}

async function sbToggleLike(trainingId, userId) {
  const existing = db.likes.find(l => l.trainingId === trainingId && l.userId === userId);
  if (existing) {
    await sbFetch(`likes?id=eq.${existing.id}&owner_id=eq.${currentUser.id}`, 'DELETE');
  } else {
    await sbFetch('likes', 'POST', {
      owner_id: currentUser.id, training_id: trainingId, user_id: userId
    });
  }
  await loadAllData();
  renderTrainings();
  renderDashboard();
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  USERS
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
async function saveUser() {
  const name = document.getElementById('u_name').value.trim();
  if (!name) { alert('åå‰ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„'); return; }
  const height = parseFloat(document.getElementById('u_height').value) || null;
  const target = parseFloat(document.getElementById('u_target').value) || null;
  // ãƒ­ã‚°ã‚¤ãƒ³ç¢ºèª
  if (!currentUser) { alert('ãƒ­ã‚°ã‚¤ãƒ³ã—ã¦ã„ã¾ã›ã‚“ã€‚å†åº¦ãƒ­ã‚°ã‚¤ãƒ³ã—ã¦ãã ã•ã„ã€‚'); return; }
  const btn = document.querySelector('#modalUser .btn-primary');
  if (btn) { btn.textContent = 'ä¿å­˜ä¸­...'; btn.disabled = true; }
  try {
    await sbSaveUser(name, height, target);
    // ã‚¢ã‚¤ã‚³ãƒ³ç”»åƒã‚’Supabase Storageã«ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰
    const iconEl = document.getElementById('u_icon_preview');
    if (iconEl && iconEl._pendingFile && db.users.length > 0) {
      const lastUser = db.users[db.users.length - 1];
      try {
        const url = await uploadAvatar(lastUser.id, iconEl._pendingFile);
        cacheIconUrl(lastUser.id, url);
      } catch(e) { console.error('avatar upload:', e); }
      delete iconEl._pendingFile;
      delete iconEl.dataset.file;
    }
    closeModal('modalUser');
    ['u_name','u_height','u_target'].forEach(id => document.getElementById(id).value = '');
    document.getElementById('u_icon_preview').innerHTML = 'ğŸ‘¤';
    document.getElementById('u_icon_preview').style.padding = '';
    updateAll(); showToast('âœ… ãƒ¦ãƒ¼ã‚¶ãƒ¼ã‚’ç™»éŒ²ã—ã¾ã—ãŸ');
  } catch(e) {
    alert('ã‚¨ãƒ©ãƒ¼: ' + e.message);
  } finally {
    if (btn) { btn.textContent = 'ç™»éŒ²'; btn.disabled = false; }
  }
}

function openEditUser(id) {
  const u = getUser(id); if (!u) return;
  document.getElementById('eu_id').value = id;
  document.getElementById('eu_name').value = u.name;
  document.getElementById('eu_height').value = u.height || '';
  document.getElementById('eu_target').value = u.targetWeight || '';
  // æ—¢å­˜ã‚¢ã‚¤ã‚³ãƒ³ã‚’è¡¨ç¤ºï¼ˆSupabaseã‚­ãƒ£ãƒƒã‚·ãƒ¥ã‹ã‚‰ï¼‰
  const iconEl = document.getElementById('eu_icon_preview');
  const existingUrl = getCachedIconUrl(id);
  if (existingUrl) {
    iconEl.innerHTML = `<img src="${existingUrl}" style="width:100%;height:100%;object-fit:cover;">`;
    iconEl.style.padding = '0';
  } else {
    iconEl.innerHTML = 'ğŸ‘¤';
  }
  delete iconEl._pendingFile;
  delete iconEl.dataset.file;
  openModal('modalEditUser');
}

// saveUser: æ–°è¦ãƒ—ãƒ­ãƒ•ã‚£ãƒ¼ãƒ«ä½œæˆï¼ˆåå‰ã‚’metadataã‹ã‚‰è‡ªå‹•ã‚»ãƒƒãƒˆï¼‰
function openModalUser() {
  // åå‰ã‚’Supabaseã®user_metadataã‹ã‚‰è‡ªå‹•å…¥åŠ›

  openModal('modalUser');
}

async function updateUser() {
  const id   = document.getElementById('eu_id').value;
  const name = document.getElementById('eu_name').value.trim();
  if (!name) { alert('åå‰ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„'); return; }
  const height = parseFloat(document.getElementById('eu_height').value) || null;
  const target = parseFloat(document.getElementById('eu_target').value) || null;
  try {
    await sbUpdateUser(id, name, height, target);
    // ã‚¢ã‚¤ã‚³ãƒ³æ›´æ–°ï¼ˆSupabase Storageï¼‰
    const iconEl = document.getElementById('eu_icon_preview');
    if (iconEl && iconEl._pendingFile) {
      try {
        const url = await uploadAvatar(id, iconEl._pendingFile);
        cacheIconUrl(id, url);
      } catch(e) { console.error('avatar update:', e); }
      delete iconEl._pendingFile;
      delete iconEl.dataset.file;
    }
    closeModal('modalEditUser');
    updateAll(); showToast('âœ… ãƒ¦ãƒ¼ã‚¶ãƒ¼æƒ…å ±ã‚’æ›´æ–°ã—ã¾ã—ãŸ');
  } catch(e) { alert('ã‚¨ãƒ©ãƒ¼: ' + e.message); }
}

async function deleteUser(id) {
  if (!confirm('ã“ã®ãƒ¦ãƒ¼ã‚¶ãƒ¼ã¨å…¨ãƒ‡ãƒ¼ã‚¿ã‚’å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿ')) return;
  try {
    await sbDeleteUser(id);
    updateAll(); showToast('ğŸ—‘ï¸ ãƒ¦ãƒ¼ã‚¶ãƒ¼ã‚’å‰Šé™¤ã—ã¾ã—ãŸ');
  } catch(e) { alert('ã‚¨ãƒ©ãƒ¼: ' + e.message); }
}

function renderUsers() {
  const grid = document.getElementById('userGrid');
  if (!db.users.length) {
    grid.innerHTML = `<div class="empty"><div class="empty-icon">ğŸ‘¥</div><div class="empty-text">ãƒ¦ãƒ¼ã‚¶ãƒ¼ã‚’è¿½åŠ ã—ã¦ãã ã•ã„</div></div>`;
    return;
  }
  grid.innerHTML = db.users.map((u,i) => {
    const color = USER_COLORS[i % USER_COLORS.length];
    const uts = db.trainings.filter(t => t.userId === u.id).length;
    const uws = db.weights.filter(w => w.userId === u.id).sort((a,b) => b.date.localeCompare(a.date));
    const latest = uws[0];
    const diff = latest && u.targetWeight ? (latest.weight - u.targetWeight).toFixed(1) : null;
    const prog = latest && u.targetWeight
      ? Math.min(100, Math.max(5, (u.targetWeight / latest.weight) * 100)).toFixed(0)
      : 0;
    return `<div class="user-card" style="border-top-color:${color}">
      <div class="user-card-header">
        <div style="display:flex;align-items:center;gap:12px;">
          ${getIconHtml(u.id, 44)}
          <div>
            <div class="user-name">${esc(u.name)}</div>
            ${u.height ? `<div class="user-sub">èº«é•· ${u.height} cm</div>` : ''}
          </div>
        </div>
        <div style="display:flex;gap:6px;">
          <button class="btn btn-sm" style="background:${color}22;color:${color};border:1px solid ${color}44;" onclick="openEditUser('${u.id}')">ç·¨é›†</button>
          <button class="btn btn-danger btn-sm" onclick="deleteUser('${u.id}')">å‰Šé™¤</button>
        </div>
      </div>
      <div class="user-stats">
        <div class="user-stat">
          <div class="user-stat-val" style="color:${color}">${uts}</div>
          <div class="user-stat-label">ãƒˆãƒ¬ãƒ¼ãƒ‹ãƒ³ã‚°</div>
        </div>
        <div class="user-stat">
          <div class="user-stat-val" style="color:var(--green)">${latest ? latest.weight + 'kg' : '--'}</div>
          <div class="user-stat-label">ç¾åœ¨ä½“é‡</div>
        </div>
      </div>
      ${u.targetWeight ? `
      <div style="margin-bottom:6px;">
        <div style="display:flex;justify-content:space-between;font-size:11px;color:var(--muted);margin-bottom:5px;">
          <span>ç›®æ¨™ ${u.targetWeight} kg</span>
          ${diff !== null ? `<span class="${parseFloat(diff)<=0?'diff-neg':'diff-pos'}">${parseFloat(diff)>0?'+':''}${diff} kg</span>` : ''}
        </div>
        <div class="prog-wrap"><div class="prog-bar" style="width:${prog}%;background:${color}"></div></div>
      </div>` : ''}
    </div>`;
  }).join('');
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  TRAININGS
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function populateTrainingSelects() {
  const sel  = document.getElementById('t_user');
  const fil  = document.getElementById('filterTrainUser');
  const opts = db.users.map(u => `<option value="${u.id}">${esc(u.name)}</option>`).join('');
  sel.innerHTML  = opts;
  fil.innerHTML  = `<option value="all">ğŸ‘¥ å…¨å“¡</option>` + opts;
  document.getElementById('t_type').innerHTML = TRAINING_TYPES.map(t =>
    `<option value="${t.id}">${t.icon} ${t.label}</option>`).join('');
  document.getElementById('filterTrainType').innerHTML =
    `<option value="all">ğŸƒ å…¨ç¨®åˆ¥</option>` +
    TRAINING_TYPES.map(t => `<option value="${t.id}">${t.icon} ${t.label}</option>`).join('');
}

async function saveTraining() {
  const type = document.getElementById('t_type').value;
  const date = document.getElementById('t_date').value;
  if (!type || !date) { alert('ç¨®åˆ¥ã¨æ—¥ä»˜ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„'); return; }
  const postWeight = parseFloat(document.getElementById('t_weight').value) || null;
  const userId = document.getElementById('t_user').value;
  if (!userId) { alert('ãƒ¦ãƒ¼ã‚¶ãƒ¼ã‚’é¸æŠã—ã¦ãã ã•ã„'); return; }
  const data = {
    userId, type, date,
    location: document.getElementById('t_location').value.trim(),
    address:  document.getElementById('t_address').value.trim(),
    duration: parseFloat(document.getElementById('t_duration').value) || null,
    cal:      parseFloat(document.getElementById('t_cal').value) || null,
    postWeight,
    memo:     document.getElementById('t_memo').value.trim()
  };
  try {
    await sbSaveTraining(data);
    if (postWeight) {
      await sbSaveWeight({ userId: data.userId, weight: postWeight, date, fat: null, memo: 'ãƒˆãƒ¬ãƒ¼ãƒ‹ãƒ³ã‚°å¾Œè¨ˆæ¸¬ï¼ˆè‡ªå‹•ï¼‰' });
    }
    await loadAllData();
    closeModal('modalTraining');
    ['t_location','t_address','t_duration','t_cal','t_weight','t_memo'].forEach(id => document.getElementById(id).value = '');
    document.getElementById('t_date').value = '';
    document.getElementById('dp_t_display').textContent = 'æ—¥ä»˜ã‚’é¸æŠ';
    dpInit('dp_t', today());
    updateAll();
    showToast(postWeight ? 'âœ… ãƒˆãƒ¬ãƒ¼ãƒ‹ãƒ³ã‚°ã¨ä½“é‡ã‚’è¨˜éŒ²ã—ã¾ã—ãŸ' : 'âœ… ãƒˆãƒ¬ãƒ¼ãƒ‹ãƒ³ã‚°ã‚’è¨˜éŒ²ã—ã¾ã—ãŸ');
  } catch(e) { alert('ã‚¨ãƒ©ãƒ¼: ' + e.message); }
}

async function deleteTraining(id) {
  if (!confirm('ã“ã®è¨˜éŒ²ã‚’å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿ')) return;
  try {
    await sbDeleteTraining(id);
    await loadAllData(); renderTrainings(); renderDashboard(); showToast('ğŸ—‘ï¸ å‰Šé™¤ã—ã¾ã—ãŸ');
  } catch(e) { alert('ã‚¨ãƒ©ãƒ¼: ' + e.message); }
}

function openEditTraining(t) {
  document.getElementById('et_id').value       = t.id;
  // ãƒ¦ãƒ¼ã‚¶ãƒ¼selectè¨­å®š
  const userSel = document.getElementById('et_user');
  userSel.innerHTML = db.users.map(u => `<option value="${u.id}">${esc(u.name)}</option>`).join('');
  userSel.value = t.userId;
  document.getElementById('et_location').value = t.location || '';
  document.getElementById('et_address').value  = t.address  || '';
  document.getElementById('et_duration').value = t.duration || '';
  document.getElementById('et_weight').value   = t.postWeight || '';
  document.getElementById('et_cal').value      = t.cal      || '';
  document.getElementById('et_memo').value     = t.memo     || '';
  // ç¨®åˆ¥ã‚»ãƒ¬ã‚¯ãƒˆ
  document.getElementById('et_type').innerHTML = TRAINING_TYPES.map(tp =>
    `<option value="${tp.id}"${tp.id === t.type ? ' selected' : ''}>${tp.icon} ${tp.label}</option>`).join('');
  dpInit('dp_et', t.date || today());
  openModal('modalEditTraining');
}

async function updateTraining() {
  const id     = document.getElementById('et_id').value;
  const userId = document.getElementById('et_user').value;
  const type   = document.getElementById('et_type').value;
  const date   = document.getElementById('et_date').value;
  if (!userId || !type || !date) { alert('ãƒ¦ãƒ¼ã‚¶ãƒ¼ãƒ»ç¨®åˆ¥ãƒ»æ—¥ä»˜ã¯å¿…é ˆã§ã™'); return; }
  const newPostWeight = parseFloat(document.getElementById('et_weight').value) || null;
  const data = {
    userId, type, date,
    location: document.getElementById('et_location').value.trim(),
    address:  document.getElementById('et_address').value.trim(),
    duration: parseFloat(document.getElementById('et_duration').value) || null,
    cal:      parseFloat(document.getElementById('et_cal').value) || null,
    postWeight: newPostWeight,
    memo: document.getElementById('et_memo').value.trim()
  };
  try {
    await sbUpdateTraining(id, data);
    if (newPostWeight) {
      // åŒæ—¥ãƒ»åŒãƒ¦ãƒ¼ã‚¶ãƒ¼ã®ä½“é‡è¨˜éŒ²ãŒæ—¢ã«ã‚ã‚‹ã‹ç¢ºèªã—ã¦ãªã‘ã‚Œã°è¿½åŠ 
      const existing = db.weights.find(w => w.userId === document.getElementById('et_user')?.value && w.date === date);
      if (!existing) {
        const uid = db.trainings.find(t => t.id === id)?.userId;
        if (uid) await sbSaveWeight({ userId: uid, weight: newPostWeight, date, fat: null, memo: 'ãƒˆãƒ¬ãƒ¼ãƒ‹ãƒ³ã‚°å¾Œè¨ˆæ¸¬ï¼ˆè‡ªå‹•ï¼‰' });
      }
    }
    await loadAllData(); closeModal('modalEditTraining');
    updateAll(); showToast('âœ… ãƒˆãƒ¬ãƒ¼ãƒ‹ãƒ³ã‚°ã‚’æ›´æ–°ã—ã¾ã—ãŸ');
  } catch(e) { alert('ã‚¨ãƒ©ãƒ¼: ' + e.message); }
}

function renderTrainings() {
  const list    = document.getElementById('trainingList');
  const fuv     = document.getElementById('filterTrainUser').value;
  const ftv     = document.getElementById('filterTrainType').value;
  const filtered = db.trainings
    .filter(t => fuv === 'all' || t.userId === fuv)
    .filter(t => ftv === 'all' || t.type === ftv)
    .sort((a,b) => b.date.localeCompare(a.date));

  if (!db.users.length) {
    list.innerHTML = `<div class="empty"><div class="empty-icon">ğŸ‘¥</div><div class="empty-text">å…ˆã«ãƒ¦ãƒ¼ã‚¶ãƒ¼ã‚’ç™»éŒ²ã—ã¦ãã ã•ã„</div></div>`; return;
  }
  if (!filtered.length) {
    list.innerHTML = `<div class="empty"><div class="empty-icon">ğŸ’ª</div><div class="empty-text">ãƒˆãƒ¬ãƒ¼ãƒ‹ãƒ³ã‚°è¨˜éŒ²ãŒã‚ã‚Šã¾ã›ã‚“</div></div>`; return;
  }
  list.innerHTML = '';
  filtered.forEach(t => {
    const u  = getUser(t.userId);
    const tp = getType(t.type);
    const col = userColor(t.userId);
    const dateDisp = t.date ? t.date.replace(/-/g, '/') : '---';
    const div = document.createElement('div');
    div.className = 'list-item';
    div.style.cssText = `border-left-color:${col}`;
    div.innerHTML = `
      <div class="list-item-icon" style="position:relative;width:44px;height:44px;flex-shrink:0;">
        ${getIconHtml(t.userId, 44)}
        <div style="position:absolute;bottom:-2px;right:-2px;background:var(--bg2);border-radius:50%;width:20px;height:20px;display:flex;align-items:center;justify-content:center;font-size:12px;border:1px solid var(--border);">${tp?.icon||'âš¡'}</div>
      </div>
      <div class="list-item-body">
        <div class="list-item-title">
          ${esc(tp?.label||t.type)}
          <span class="badge" style="background:${col}22;color:${col};border-color:${col}44;margin-left:8px;">${esc(u?.name||'?')}</span>
        </div>
        <div class="list-item-meta">
          ğŸ“… ${dateDisp}
          ${t.location ? ` &nbsp;ğŸ“ ${esc(t.location)}` : ''}
          ${t.address  ? ` &nbsp;ğŸ—ºï¸ ${esc(t.address)}`  : ''}
        </div>
      </div>
      <div class="list-item-actions">
        ${t.duration ? `<div style="text-align:center"><div style="font-family:var(--font-display);font-size:20px;color:var(--accent);font-weight:800">${t.duration}</div><div style="font-size:9px;color:var(--muted)">åˆ†</div></div>` : ''}
        ${t.cal ? `<div style="text-align:center"><div style="font-family:var(--font-display);font-size:20px;color:var(--gold);font-weight:800">${t.cal}</div><div style="font-size:9px;color:var(--muted)">kcal</div></div>` : ''}
        ${t.postWeight ? `<div style="text-align:center"><div style="font-family:var(--font-display);font-size:20px;color:var(--green);font-weight:800">${t.postWeight}</div><div style="font-size:9px;color:var(--muted)">kg</div></div>` : ''}
        <button class="btn btn-sm" style="background:rgba(255,209,102,0.15);color:#FFD166;border:1px solid rgba(255,209,102,0.3);" data-edit-train>ç·¨é›†</button>
        <button class="btn btn-danger btn-sm" data-del-train>å‰Šé™¤</button>
      </div>
      ${t.memo ? `<div class="memo-row">ğŸ’¬ ${esc(t.memo)}</div>` : ''}
      <div class="like-row" data-like-row></div>
    `;
    // ã„ã„ã­ãƒœã‚¿ãƒ³æç”»
    const likeRow = div.querySelector('[data-like-row]');
    db.users.forEach(u => {
      const liked = db.likes.some(l => l.trainingId === t.id && l.userId === u.id);
      const likeCount = db.likes.filter(l => l.trainingId === t.id && l.userId === u.id).length;
      const btn = document.createElement('button');
      btn.className = 'like-btn' + (liked ? ' liked' : '');
      btn.innerHTML = `${getIconHtml(u.id, 20)}<span class="like-thumb">ğŸ‘</span>`;
      btn.title = u.name;
      btn.addEventListener('click', () => sbToggleLike(t.id, u.id));
      likeRow.appendChild(btn);
    });
    // ã„ã„ã­åˆè¨ˆãƒãƒƒã‚¸
    const totalLikes = db.likes.filter(l => l.trainingId === t.id).length;
    if (totalLikes > 0) {
      const badge = document.createElement('span');
      badge.className = 'like-total';
      badge.textContent = 'ğŸ‘ ' + totalLikes;
      likeRow.appendChild(badge);
    }
    div.querySelector('[data-del-train]').addEventListener('click', () => deleteTraining(t.id));
    div.querySelector('[data-edit-train]').addEventListener('click', () => openEditTraining(t));
    list.appendChild(div);
  });
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  WEIGHTS
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
let weightChart = null;
let dashWeightChart = null;

function populateWeightSelects() {
  const sel  = document.getElementById('w_user');
  const fil  = document.getElementById('filterWeightUser');
  const opts = db.users.map(u => `<option value="${u.id}">${esc(u.name)}</option>`).join('');
  sel.innerHTML = opts;
  fil.innerHTML = `<option value="all">ğŸ‘¥ å…¨å“¡</option>` + opts;
}

async function saveWeight() {
  const userId = document.getElementById('w_user').value;
  const weight = parseFloat(document.getElementById('w_weight').value);
  const date   = document.getElementById('w_date').value;
  if (!userId || !weight || !date) { alert('å¿…é ˆé …ç›®ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„'); return; }
  try {
    await sbSaveWeight({
      userId, weight, date,
      fat:  parseFloat(document.getElementById('w_fat').value) || null,
      memo: document.getElementById('w_memo').value.trim()
    });
    await loadAllData();
    closeModal('modalWeight');
    ['w_weight','w_fat','w_memo'].forEach(id => document.getElementById(id).value = '');
    document.getElementById('w_date').value = '';
    document.getElementById('dp_w_display').textContent = 'æ—¥ä»˜ã‚’é¸æŠ';
    dpInit('dp_w', today());
    updateAll(); showToast('âœ… ä½“é‡ã‚’è¨˜éŒ²ã—ã¾ã—ãŸ');
  } catch(e) { alert('ã‚¨ãƒ©ãƒ¼: ' + e.message); }
}

async function deleteWeight(id) {
  if (!confirm('ã“ã®è¨˜éŒ²ã‚’å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿ')) return;
  try {
    await sbDeleteWeight(id);
    await loadAllData(); renderWeights(); renderDashboard(); showToast('ğŸ—‘ï¸ å‰Šé™¤ã—ã¾ã—ãŸ');
  } catch(e) { alert('ã‚¨ãƒ©ãƒ¼: ' + e.message); }
}

function openEditWeight(w) {
  document.getElementById('ew_id').value     = w.id;
  // ãƒ¦ãƒ¼ã‚¶ãƒ¼selectè¨­å®š
  const userSel = document.getElementById('ew_user');
  userSel.innerHTML = db.users.map(u => `<option value="${u.id}">${esc(u.name)}</option>`).join('');
  userSel.value = w.userId;
  document.getElementById('ew_weight').value = w.weight;
  document.getElementById('ew_fat').value    = w.fat || '';
  document.getElementById('ew_memo').value   = w.memo || '';
  dpInit('dp_ew', w.date || today());
  openModal('modalEditWeight');
}

async function updateWeight() {
  const id     = document.getElementById('ew_id').value;
  const weight = parseFloat(document.getElementById('ew_weight').value);
  const date   = document.getElementById('ew_date').value;
  if (!weight || !date) { alert('ä½“é‡ã¨æ—¥ä»˜ã¯å¿…é ˆã§ã™'); return; }
  try {
    await sbUpdateWeight(id, {
      weight, date,
      fat:  parseFloat(document.getElementById('ew_fat').value) || null,
      memo: document.getElementById('ew_memo').value.trim()
    });
    await loadAllData(); closeModal('modalEditWeight');
    updateAll(); showToast('âœ… ä½“é‡è¨˜éŒ²ã‚’æ›´æ–°ã—ã¾ã—ãŸ');
  } catch(e) { alert('ã‚¨ãƒ©ãƒ¼: ' + e.message); }
}

function renderWeights() {
  const list    = document.getElementById('weightList');
  const chartWrap = document.getElementById('weightChartWrap');
  const fuv     = document.getElementById('filterWeightUser').value;
  const filtered = db.weights
    .filter(w => fuv === 'all' || w.userId === fuv)
    .sort((a,b) => b.date.localeCompare(a.date));

  // Chart
  if (fuv !== 'all') {
    const u = getUser(fuv);
    const sorted = db.weights.filter(w => w.userId === fuv).sort((a,b) => a.date.localeCompare(b.date));
    if (sorted.length > 1) {
      chartWrap.style.display = 'block';
      document.getElementById('weightChartTitle').textContent = (u?.name||'') + ' ã®ä½“é‡æ¨ç§»';
      if (weightChart) weightChart.destroy();
      const ctx = document.getElementById('chartWeight').getContext('2d');
      const datasets = [{
        label: 'ä½“é‡(kg)',
        data: sorted.map(w => w.weight),
        borderColor: '#3DFF8F', backgroundColor: 'rgba(61,255,143,0.1)',
        tension: 0.4, pointBackgroundColor: '#3DFF8F', pointRadius: 4
      }];
      if (sorted.some(w => w.fat)) {
        datasets.push({
          label: 'ä½“è„‚è‚ªç‡(%)',
          data: sorted.map(w => w.fat),
          borderColor: '#FF4D6A', backgroundColor: 'rgba(255,77,106,0.08)',
          tension: 0.4, pointBackgroundColor: '#FF4D6A', pointRadius: 4, yAxisID: 'y2'
        });
      }
      if (u?.targetWeight) {
        datasets.push({
          label: `ç›®æ¨™ ${u.targetWeight}kg`,
          data: sorted.map(() => u.targetWeight),
          borderColor: '#FFD166', borderDash: [6,3],
          pointRadius: 0, backgroundColor: 'transparent'
        });
      }
      weightChart = new Chart(ctx, {
        type: 'line',
        data: { labels: sorted.map(w => w.date.slice(5)), datasets },
        options: {
          responsive: true,
          plugins: { legend: { labels: { color: '#4A6578', font: { size: 11 } } } },
          scales: {
            x: { ticks: { color: '#4A6578', font:{size:10} }, grid: { color: '#1A3044' } },
            y: { ticks: { color: '#4A6578', font:{size:10} }, grid: { color: '#1A3044' } },
            ...(sorted.some(w=>w.fat) ? { y2: { position:'right', ticks:{color:'#FF4D6A',font:{size:10}}, grid:{display:false} } } : {})
          }
        }
      });
    } else { chartWrap.style.display = 'none'; }
  } else { chartWrap.style.display = 'none'; }

  if (!db.users.length) {
    list.innerHTML = `<div class="empty"><div class="empty-icon">ğŸ‘¥</div><div class="empty-text">å…ˆã«ãƒ¦ãƒ¼ã‚¶ãƒ¼ã‚’ç™»éŒ²ã—ã¦ãã ã•ã„</div></div>`; return;
  }
  if (!filtered.length) {
    list.innerHTML = `<div class="empty"><div class="empty-icon">âš–ï¸</div><div class="empty-text">ä½“é‡è¨˜éŒ²ãŒã‚ã‚Šã¾ã›ã‚“</div></div>`; return;
  }
  list.innerHTML = '';
  filtered.forEach(w => {
    const u   = getUser(w.userId);
    const col = userColor(w.userId);
    const diff = u?.targetWeight ? (w.weight - u.targetWeight).toFixed(1) : null;
    const dateDisp = w.date ? w.date.replace(/-/g, '/') : '---';
    const div = document.createElement('div');
    div.className = 'list-item';
    div.style.cssText = `border-left-color:${col}`;
    div.innerHTML = `
      <div class="list-item-icon" style="position:relative;width:44px;height:44px;flex-shrink:0;">
        ${getIconHtml(w.userId, 44)}
        <div style="position:absolute;bottom:-2px;right:-2px;background:var(--bg2);border-radius:50%;width:20px;height:20px;display:flex;align-items:center;justify-content:center;font-size:12px;border:1px solid var(--border);">âš–ï¸</div>
      </div>
      <div class="list-item-body">
        <div class="list-item-title">
          <span class="badge" style="background:${col}22;color:${col};border-color:${col}44;">${esc(u?.name||'?')}</span>
          <span style="margin-left:8px;font-size:12px;color:var(--muted)">ğŸ“… ${dateDisp}</span>
        </div>
        <div class="list-item-meta">
          ${w.fat ? `ä½“è„‚è‚ªç‡: ${w.fat}%` : ''}
          ${w.memo ? ` &nbsp;ğŸ’¬ ${esc(w.memo)}` : ''}
        </div>
      </div>
      <div class="list-item-actions" style="gap:10px;">
        <div style="text-align:right;">
          <div class="weight-big">${w.weight} kg</div>
          ${diff !== null ? `<div style="font-size:12px;" class="${parseFloat(diff)<=0?'diff-neg':'diff-pos'}">ç›®æ¨™ã¾ã§ ${parseFloat(diff)>0?'+':''}${diff} kg</div>` : ''}
        </div>
        <button class="btn btn-sm" style="background:rgba(255,209,102,0.15);color:#FFD166;border:1px solid rgba(255,209,102,0.3);" data-edit-weight="${w.id}">ç·¨é›†</button>
        <button class="btn btn-danger btn-sm" data-del-weight="${w.id}">å‰Šé™¤</button>
      </div>
    `;
    // å‰Šé™¤ãƒœã‚¿ãƒ³
    div.querySelector('[data-del-weight]').addEventListener('click', () => deleteWeight(w.id));
    // ç·¨é›†ãƒœã‚¿ãƒ³
    div.querySelector('[data-edit-weight]').addEventListener('click', () => openEditWeight(w));
    list.appendChild(div);
  });
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  DASHBOARD
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
let trendChart = null;

function renderDashboard() {
  const thisMonth = new Date().toISOString().slice(0,7);
  const totalMin  = db.trainings.reduce((s,t) => s + (t.duration||0), 0);

  // â”€â”€ æœˆã‚»ãƒ¬ã‚¯ã‚¿ãƒ¼ã‚’æ§‹ç¯‰ï¼ˆãƒ‡ãƒ¼ã‚¿ã®ã‚ã‚‹æœˆ + å½“æœˆï¼‰â”€â”€
  const monthSel = document.getElementById('dashMonthSelect');
  const existingMonths = [...new Set(db.trainings.map(t => t.date.slice(0,7)))].sort().reverse();
  if (!existingMonths.includes(thisMonth)) existingMonths.unshift(thisMonth);
  // ç¾åœ¨ã®é¸æŠå€¤ã‚’ä¿æŒï¼ˆãªã‘ã‚Œã°å½“æœˆï¼‰
  const prevVal = monthSel.value || thisMonth;
  monthSel.innerHTML = existingMonths.map(m => {
    const [y, mo] = m.split('-');
    return `<option value="${m}" ${m===prevVal?'selected':''}>${y}å¹´${parseInt(mo)}æœˆ</option>`;
  }).join('');
  const selMonth = monthSel.value || thisMonth;

  // â”€â”€ Statsï¼ˆé¸æŠæœˆãƒ™ãƒ¼ã‚¹ï¼‰â”€â”€
  const monthTs = db.trainings.filter(t => t.date.startsWith(selMonth)).length;
  const isThisMonth = selMonth === thisMonth;
  document.getElementById('statsGrid').innerHTML = `
    <div class="stat-card c-accent"><div class="stat-icon">ğŸ‘¥</div><div class="stat-label">ãƒ¦ãƒ¼ã‚¶ãƒ¼æ•°</div><div class="stat-value">${db.users.length}</div></div>
    <div class="stat-card c-red"><div class="stat-icon">ğŸ’ª</div><div class="stat-label">ç·ãƒˆãƒ¬ãƒ¼ãƒ‹ãƒ³ã‚°</div><div class="stat-value">${db.trainings.length}</div></div>
    <div class="stat-card c-green"><div class="stat-icon">ğŸ“…</div><div class="stat-label">${isThisMonth?'ä»Šæœˆ':selMonth.replace('-','å¹´')+'æœˆ'}</div><div class="stat-value">${monthTs}</div><div class="stat-sub">å›</div></div>
    <div class="stat-card c-gold"><div class="stat-icon">â±ï¸</div><div class="stat-label">ç·æ™‚é–“</div><div class="stat-value">${totalMin ? (totalMin/60).toFixed(1) : 0}</div><div class="stat-sub">æ™‚é–“</div></div>
  `;

  // â”€â”€ æ¨ªæ£’ã‚°ãƒ©ãƒ•ï¼ˆé¸æŠæœˆã®ãƒ¦ãƒ¼ã‚¶ãƒ¼åˆ¥ãƒˆãƒ¬ãƒ¼ãƒ‹ãƒ³ã‚°å›æ•°ï¼‰â”€â”€
  const barsEl = document.getElementById('dashTrainBars');
  const userCounts = db.users.map((u, idx) => ({
    user: u,
    count: db.trainings.filter(t => t.userId === u.id && t.date.slice(0,7) === selMonth).length,
    color: USER_COLORS[idx % USER_COLORS.length]
  })).sort((a,b) => b.count - a.count);
  const maxCount = Math.max(...userCounts.map(u => u.count), 1);

  if (!db.users.length) {
    barsEl.innerHTML = `<div class="empty" style="padding:20px 0;color:var(--muted);">ãƒ¦ãƒ¼ã‚¶ãƒ¼ã‚’ç™»éŒ²ã—ã¦ãã ã•ã„</div>`;
  } else if (userCounts.every(u => u.count === 0)) {
    barsEl.innerHTML = `<div class="empty" style="padding:20px 0;color:var(--muted);">ã“ã®æœˆã®ãƒ‡ãƒ¼ã‚¿ãŒã‚ã‚Šã¾ã›ã‚“</div>`;
  } else {
    barsEl.innerHTML = userCounts.map(({user, count, color}) => `
      <div style="display:flex;align-items:center;gap:12px;margin-bottom:14px;">
        <div style="flex-shrink:0;">${getIconHtml(user.id, 36)}</div>
        <div style="flex:1;min-width:0;">
          <div style="display:flex;justify-content:space-between;margin-bottom:5px;">
            <span style="font-size:13px;font-weight:600;color:var(--text);">${esc(user.name)}</span>
            <span style="font-family:var(--font-display);font-size:22px;font-weight:800;color:${color};">${count}<span style="font-size:12px;color:var(--muted);margin-left:3px;">å›</span></span>
          </div>
          <div style="height:10px;background:var(--bg3);border-radius:99px;overflow:hidden;">
            <div style="height:100%;width:${count===0?0:(count/maxCount*100).toFixed(0)}%;background:${color};border-radius:99px;transition:width 0.4s ease;"></div>
          </div>
        </div>
      </div>`).join('');
  }

  // â”€â”€ æœˆåˆ¥æ¶ˆè²»ã‚«ãƒ­ãƒªãƒ¼æ¨ªæ£’ã‚°ãƒ©ãƒ• â”€â”€
  const calBarsEl = document.getElementById('dashCalBars');
  const userCals = db.users.map((u, idx) => ({
    user: u,
    cal: db.trainings
      .filter(t => t.userId === u.id && t.date.slice(0,7) === selMonth && t.cal)
      .reduce((s, t) => s + (t.cal||0), 0),
    color: USER_COLORS[idx % USER_COLORS.length]
  })).sort((a,b) => b.cal - a.cal);
  const maxCal = Math.max(...userCals.map(u => u.cal), 1);

  if (!db.users.length) {
    calBarsEl.innerHTML = `<div class="empty" style="padding:20px 0;color:var(--muted);">ãƒ¦ãƒ¼ã‚¶ãƒ¼ã‚’ç™»éŒ²ã—ã¦ãã ã•ã„</div>`;
  } else if (userCals.every(u => u.cal === 0)) {
    calBarsEl.innerHTML = `<div class="empty" style="padding:20px 0;color:var(--muted);">ã“ã®æœˆã®ã‚«ãƒ­ãƒªãƒ¼ãƒ‡ãƒ¼ã‚¿ãŒã‚ã‚Šã¾ã›ã‚“</div>`;
  } else {
    calBarsEl.innerHTML = userCals.map(({user, cal, color}) => `
      <div style="display:flex;align-items:center;gap:12px;margin-bottom:14px;">
        <div style="flex-shrink:0;">${getIconHtml(user.id, 36)}</div>
        <div style="flex:1;min-width:0;">
          <div style="display:flex;justify-content:space-between;margin-bottom:5px;">
            <span style="font-size:13px;font-weight:600;color:var(--text);">${esc(user.name)}</span>
            <span style="font-family:var(--font-display);font-size:22px;font-weight:800;color:${color};">${cal.toLocaleString()}<span style="font-size:12px;color:var(--muted);margin-left:3px;">kcal</span></span>
          </div>
          <div style="height:10px;background:var(--bg3);border-radius:99px;overflow:hidden;">
            <div style="height:100%;width:${cal===0?0:(cal/maxCal*100).toFixed(0)}%;background:${color};border-radius:99px;transition:width 0.4s ease;"></div>
          </div>
        </div>
      </div>`).join('');
  }

  // â”€â”€ ä½“é‡æ¨ç§»ã‚°ãƒ©ãƒ•ï¼ˆå½“æœˆï¼‰ â”€â”€
  const canvas = document.getElementById('dashWeightChart');
  const emptyEl = document.getElementById('dashWeightEmpty');
  const monthWeights = db.weights.filter(w => w.date.slice(0,7) === selMonth).sort((a,b) => a.date.localeCompare(b.date));
  
  if (dashWeightChart) dashWeightChart.destroy();
  
  if (!db.users.length || monthWeights.length === 0) {
    canvas.style.display = 'none';
    emptyEl.style.display = 'block';
  } else {
    canvas.style.display = 'block';
    emptyEl.style.display = 'none';
    
    const datasets = db.users.map((u, idx) => {
      const userWeights = monthWeights.filter(w => w.userId === u.id);
      return {
        label: u.name,
        data: userWeights.map(w => ({ x: w.date.slice(5), y: w.weight })),
        borderColor: USER_COLORS[idx % USER_COLORS.length],
        backgroundColor: 'transparent',
        tension: 0.3,
        pointBackgroundColor: USER_COLORS[idx % USER_COLORS.length],
        pointRadius: 4,
        pointHoverRadius: 6
      };
    }).filter(ds => ds.data.length > 0);
    
    const ctx = canvas.getContext('2d');
    dashWeightChart = new Chart(ctx, {
      type: 'line',
      data: { datasets },
      options: {
        responsive: true,
        maintainAspectRatio: false,
        plugins: {
          legend: {
            display: db.users.length > 1,
            labels: { color: '#8899A6', font: { size: 11 }, boxWidth: 12 }
          }
        },
        scales: {
          x: {
            type: 'category',
            ticks: { color: '#4A6578', font: { size: 10 } },
            grid: { color: '#1A3044' }
          },
          y: {
            ticks: { color: '#4A6578', font: { size: 10 } },
            grid: { color: '#1A3044' }
          }
        }
      }
    });
  }

  // Type Bars
  const typeCnt = {};
  TRAINING_TYPES.forEach(t => typeCnt[t.id] = 0);
  db.trainings.forEach(t => { typeCnt[t.type] = (typeCnt[t.type]||0) + 1; });
  const sorted = TRAINING_TYPES.map(t => ({...t, cnt: typeCnt[t.id]||0})).filter(t=>t.cnt>0).sort((a,b)=>b.cnt-a.cnt);
  const maxCnt = sorted.length ? Math.max(...sorted.map(t=>t.cnt)) : 1;
  const colors = ['#00D4FF','#FF4D6A','#3DFF8F','#FFD166','#FF69B4','#B48EFF'];
  document.getElementById('typeBars').innerHTML = sorted.length
    ? sorted.slice(0,8).map((t,i) => `
        <div class="type-bar-row">
          <div class="type-bar-label">${t.icon} ${t.label}</div>
          <div class="type-bar-track"><div class="type-bar-fill" style="width:${(t.cnt/maxCnt*100).toFixed(0)}%;background:${colors[i%colors.length]};"></div></div>
          <div class="type-bar-count">${t.cnt}</div>
        </div>`).join('')
    : `<div style="color:var(--muted);font-size:13px;padding:10px 0;">ãƒ‡ãƒ¼ã‚¿ãŒã‚ã‚Šã¾ã›ã‚“</div>`;

  // â”€â”€ æœ€æ–°ãƒˆãƒ¬ãƒ¼ãƒ‹ãƒ³ã‚° â”€â”€
  const latestEl = document.getElementById('dashLatestTrainings');
  if (!db.users.length) {
    latestEl.innerHTML = `<div class="empty" style="padding:16px 0;color:var(--muted);">ãƒ¦ãƒ¼ã‚¶ãƒ¼ã‚’ç™»éŒ²ã—ã¦ãã ã•ã„</div>`;
  } else {
    const latestItems = db.users.map((u, idx) => {
      const color = USER_COLORS[idx % USER_COLORS.length];
      const trains = db.trainings.filter(t => t.userId === u.id).sort((a,b) => b.date.localeCompare(a.date));
      const latest = trains[0];
      if (!latest) return `
        <div style="display:flex;align-items:center;gap:10px;padding:10px 0;border-bottom:1px solid var(--border);">
          <div style="flex-shrink:0;">${getIconHtml(u.id, 36)}</div>
          <div style="flex:1;">
            <div style="font-size:13px;font-weight:600;color:var(--text);">${esc(u.name)}</div>
            <div style="font-size:12px;color:var(--muted);margin-top:2px;">è¨˜éŒ²ãªã—</div>
          </div>
        </div>`;
      const tp = getType(latest.type);
      return `
        <div style="display:flex;align-items:flex-start;gap:10px;padding:10px 0;border-bottom:1px solid var(--border);">
          <div style="flex-shrink:0;">${getIconHtml(u.id, 36)}</div>
          <div style="flex:1;min-width:0;">
            <div style="display:flex;align-items:center;gap:6px;margin-bottom:3px;">
              <span style="font-size:13px;font-weight:600;color:var(--text);">${esc(u.name)}</span>
              <span style="font-size:11px;background:${color}22;color:${color};border:1px solid ${color}44;border-radius:4px;padding:1px 6px;">${tp?.icon||'âš¡'} ${tp?.label||latest.type}</span>
            </div>
            <div style="font-size:12px;color:var(--muted);">ğŸ“… ${latest.date.replace(/-/g,'/')}</div>
            ${latest.memo ? `<div style="font-size:12px;color:var(--muted);margin-top:2px;white-space:nowrap;overflow:hidden;text-overflow:ellipsis;">ğŸ’¬ ${esc(latest.memo)}</div>` : ''}
          </div>
        </div>`;
    }).join('');
    latestEl.innerHTML = latestItems + '<style>#dashLatestTrainings > div:last-of-type { border-bottom: none; }</style>';
  }

  // Weight User Grid
  const wug = document.getElementById('weightUserGrid');
  if (!db.users.length) {
    wug.innerHTML = `<div style="color:var(--muted);font-size:13px;padding:10px;">ãƒ¦ãƒ¼ã‚¶ãƒ¼ã‚’ç™»éŒ²ã—ã¦ãã ã•ã„</div>`; return;
  }
  wug.innerHTML = db.users.map((u,i) => {
    const color = USER_COLORS[i % USER_COLORS.length];
    const uws = db.weights.filter(w => w.userId === u.id).sort((a,b) => b.date.localeCompare(a.date));
    const latest = uws[0];
    const diff = latest && u.targetWeight ? (latest.weight - u.targetWeight).toFixed(1) : null;
    const prog = latest && u.targetWeight
      ? Math.min(100, Math.max(5, (u.targetWeight / latest.weight) * 100)).toFixed(0)
      : 0;
    return `<div class="weight-user-card" style="border-left-color:${color}">
      <div class="weight-user-name">${esc(u.name)}</div>
      ${latest ? `
        <div style="display:flex;justify-content:space-between;margin-bottom:4px;">
          <span style="font-size:11px;color:var(--muted)">æœ€æ–°</span>
          <span style="font-family:var(--font-display);font-size:20px;color:${color};font-weight:800">${latest.weight} kg</span>
        </div>
        ${u.targetWeight ? `
        <div style="display:flex;justify-content:space-between;margin-bottom:6px;">
          <span style="font-size:11px;color:var(--muted)">ç›®æ¨™ ${u.targetWeight}kg</span>
          ${diff!==null ? `<span style="font-size:12px;" class="${parseFloat(diff)<=0?'diff-neg':'diff-pos'}">${parseFloat(diff)>0?'+':''}${diff}kg</span>` : ''}
        </div>
        <div class="prog-wrap"><div class="prog-bar" style="width:${prog}%;background:${color}"></div></div>
        ` : ''}
        <div style="font-size:10px;color:var(--muted);margin-top:6px;">${latest.date}</div>
      ` : `<div style="color:var(--muted);font-size:12px;">ä½“é‡ãƒ‡ãƒ¼ã‚¿ãªã—</div>`}
    </div>`;
  }).join('');
}


// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  CSV IMPORT
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
let csvParsed = [];
let csvHeaders = [];

function csvReset() {
  csvParsed = []; csvHeaders = [];
  const s1 = document.getElementById('csvStep1');
  const s2 = document.getElementById('csvStep2');
  const nb = document.getElementById('csvNextBtn');
  const ib = document.getElementById('csvImportBtn');
  if (s1) s1.style.display = 'block';
  if (s2) s2.style.display = 'none';
  if (nb) nb.style.display = 'none';
  if (ib) ib.style.display = 'none';
  const fi = document.getElementById('csvFileInput');
  if (fi) fi.value = '';
}

function populateCsvUserSelect() {
  const sel = document.getElementById('csv_user');
  if (sel) sel.innerHTML = db.users.map(u => '<option value="' + u.id + '">' + esc(u.name) + '</option>').join('');
}

function initCsvDrop() {
  const zone  = document.getElementById('csvDropZone');
  const input = document.getElementById('csvFileInput');
  if (!zone || !input) return;
  const newZone = zone.cloneNode(true);
  zone.parentNode.replaceChild(newZone, zone);
  const newInput = newZone.querySelector('#csvFileInput') || document.getElementById('csvFileInput');
  newZone.addEventListener('click', () => document.getElementById('csvFileInput').click());
  newZone.addEventListener('dragover', function(e) { e.preventDefault(); newZone.style.borderColor = 'var(--accent)'; });
  newZone.addEventListener('dragleave', function() { newZone.style.borderColor = 'var(--border)'; });
  newZone.addEventListener('drop', function(e) {
    e.preventDefault(); newZone.style.borderColor = 'var(--border)';
    if (e.dataTransfer.files[0]) csvReadFile(e.dataTransfer.files[0]);
  });
  document.getElementById('csvFileInput').addEventListener('change', function() {
    if (this.files[0]) csvReadFile(this.files[0]);
  });
}

function csvReadFile(file) {
  const tryRead = function(encoding, fallback) {
    const reader = new FileReader();
    reader.onload = function(e) {
      const text = e.target.result;
      if (encoding === 'UTF-8' && text.includes('\uFFFD') && fallback) {
        tryRead('Shift_JIS', false);
      } else {
        csvParse(text);
      }
    };
    reader.readAsText(file, encoding);
  };
  tryRead('UTF-8', true);
}

function csvParse(text) {
  text = text.replace(/^\uFEFF/, '');
  const lines = text.split('\n').map(function(l){ return l.replace(/\r$/, ''); }).filter(function(l){ return l.trim() !== ''; });
  if (lines.length < 2) { alert('ãƒ‡ãƒ¼ã‚¿ãŒå°‘ãªã™ãã¾ã™ï¼ˆæœ€ä½2è¡Œå¿…è¦ï¼‰'); return; }

  const delim = lines[0].indexOf('\t') !== -1 ? '\t' : ',';
  const rows = lines.map(function(l) {
    return l.split(delim).map(function(c){ return c.trim().replace(/^"|"$/g, ''); });
  });

  const firstRow = rows[0];
  const hasHeader = isNaN(parseFloat(firstRow[0])) || firstRow.some(function(c){ return /[^\d.\-\/]/.test(c) && c.length > 0; });
  csvHeaders = hasHeader ? firstRow : firstRow.map(function(_, i){ return 'åˆ—' + (i+1); });
  csvParsed  = (hasHeader ? rows.slice(1) : rows).filter(function(r){ return r.some(function(c){ return c !== ''; }); });

  if (csvParsed.length === 0) { alert('æœ‰åŠ¹ãªãƒ‡ãƒ¼ã‚¿ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ã§ã—ãŸ'); return; }

  var dateCol = -1, weightCol = -1, fatCol = -1;
  csvHeaders.forEach(function(h, i) {
    const lh = h.toLowerCase();
    if (dateCol === -1 && ['æ—¥ä»˜','date','æ—¥','æ¸¬å®šæ—¥','è¨ˆæ¸¬æ—¥','è¨˜éŒ²æ—¥','æ™‚åˆ»'].some(function(w){ return lh.indexOf(w) !== -1; })) dateCol = i;
    if (weightCol === -1 && ['ä½“é‡','weight','kg'].some(function(w){ return lh.indexOf(w) !== -1; })) weightCol = i;
    if (fatCol === -1 && ['ä½“è„‚è‚ª','fat','è„‚è‚ª'].some(function(w){ return lh.indexOf(w) !== -1; })) fatCol = i;
  });
  if (dateCol === -1 && csvHeaders.length >= 1) dateCol = 0;
  if (weightCol === -1 && csvHeaders.length >= 2) weightCol = 1;
  if (fatCol === -1 && csvHeaders.length >= 3) fatCol = 2;

  function makeOpts(selected) {
    var html = '<option value="-1">â”€ ä½¿ç”¨ã—ãªã„ â”€</option>';
    csvHeaders.forEach(function(h, i) {
      var ex = csvParsed[0] ? (csvParsed[0][i] || '') : '';
      html += '<option value="' + i + '"' + (i === selected ? ' selected' : '') + '>' + h + 'ï¼ˆä¾‹: ' + ex + 'ï¼‰</option>';
    });
    return html;
  }

  document.getElementById('csv_col_date').innerHTML   = makeOpts(dateCol);
  document.getElementById('csv_col_weight').innerHTML = makeOpts(weightCol);
  document.getElementById('csv_col_fat').innerHTML    = makeOpts(fatCol);
  document.getElementById('csvRowCount').textContent  = csvParsed.length + ' ä»¶ã®ãƒ‡ãƒ¼ã‚¿ã‚’æ¤œå‡º';

  ['csv_col_date','csv_col_weight','csv_col_fat'].forEach(function(id) {
    const el = document.getElementById(id);
    if (el) { el.removeEventListener('change', csvUpdatePreview); el.addEventListener('change', csvUpdatePreview); }
  });

  csvUpdatePreview();

  document.getElementById('csvStep1').style.display   = 'none';
  document.getElementById('csvStep2').style.display   = 'block';
  document.getElementById('csvImportBtn').style.display = 'inline-block';
}

function csvNormalizeDate(raw) {
  if (!raw) return null;
  raw = raw.trim();
  var m;
  m = raw.match(/^(\d{4})[\/\-](\d{1,2})[\/\-](\d{1,2})/);
  if (m) return m[1] + '-' + m[2].padStart(2,'0') + '-' + m[3].padStart(2,'0');
  m = raw.match(/^(\d{1,2})[\/\-](\d{1,2})$/);
  if (m) return new Date().getFullYear() + '-' + m[1].padStart(2,'0') + '-' + m[2].padStart(2,'0');
  m = raw.match(/^(\d{4})(\d{2})(\d{2})$/);
  if (m) return m[1] + '-' + m[2] + '-' + m[3];
  return null;
}

function csvUpdatePreview() {
  const dc = parseInt(document.getElementById('csv_col_date').value);
  const wc = parseInt(document.getElementById('csv_col_weight').value);
  const fc = parseInt(document.getElementById('csv_col_fat').value);

  const preview = csvParsed.slice(0, 3).map(function(row) {
    const d = dc >= 0 ? (csvNormalizeDate(row[dc]) || row[dc]) : '?';
    const w = wc >= 0 ? row[wc] : '?';
    const f = fc >= 0 ? row[fc] : '-';
    return d + '  ä½“é‡: ' + w + 'kg  ä½“è„‚è‚ª: ' + f + '%';
  }).join('\n');
  document.getElementById('csvPreview').textContent = preview;

  const valid = csvParsed.filter(function(row) {
    const d = dc >= 0 ? csvNormalizeDate(row[dc]) : null;
    const w = wc >= 0 ? parseFloat(row[wc]) : null;
    return d && w && !isNaN(w);
  }).length;
  document.getElementById('csvImportInfo').textContent =
    'âœ… ã‚¤ãƒ³ãƒãƒ¼ãƒˆå¯èƒ½: ' + valid + ' ä»¶ / å…¨ ' + csvParsed.length + ' ä»¶';
}

function csvNext() {}

async function csvImport() {
  const userId = document.getElementById('csv_user').value;
  if (!userId) { alert('ãƒ¦ãƒ¼ã‚¶ãƒ¼ã‚’é¸æŠã—ã¦ãã ã•ã„'); return; }
  const dc = parseInt(document.getElementById('csv_col_date').value);
  const wc = parseInt(document.getElementById('csv_col_weight').value);
  const fc = parseInt(document.getElementById('csv_col_fat').value);
  if (wc < 0) { alert('ä½“é‡ã®åˆ—ã‚’æŒ‡å®šã—ã¦ãã ã•ã„'); return; }
  if (dc < 0) { alert('æ—¥ä»˜ã®åˆ—ã‚’æŒ‡å®šã—ã¦ãã ã•ã„'); return; }

  const inserts = [];
  let skipped = 0;
  csvParsed.forEach(function(row) {
    const dateStr = csvNormalizeDate(row[dc]);
    const weight  = parseFloat(row[wc]);
    if (!dateStr || isNaN(weight) || weight <= 0) { skipped++; return; }
    const fat = fc >= 0 ? parseFloat(row[fc]) || null : null;
    // é‡è¤‡ãƒã‚§ãƒƒã‚¯ï¼ˆæ—¢å­˜DBã¨ç…§åˆï¼‰
    const dup = db.weights.find(function(w) {
      return w.userId === userId && w.date === dateStr && w.weight === weight;
    });
    if (dup) { skipped++; return; }
    inserts.push({ user_id: userId, weight: weight, date: dateStr, fat: fat, memo: 'CSVã‚¤ãƒ³ãƒãƒ¼ãƒˆ' });
  });

  try {
    if (inserts.length > 0) {
      await sbFetch('weights', 'POST', inserts);
    }
    await loadAllData();
    closeModal('modalCsvImport');
    csvReset();
    updateAll();
    showToast('âœ… ' + inserts.length + ' ä»¶ã‚¤ãƒ³ãƒãƒ¼ãƒˆå®Œäº†' + (skipped ? 'ï¼ˆ' + skipped + ' ä»¶ã‚¹ã‚­ãƒƒãƒ—ï¼‰' : ''));
  } catch(e) { alert('ã‚¤ãƒ³ãƒãƒ¼ãƒˆã‚¨ãƒ©ãƒ¼: ' + e.message); }
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  UPDATE ALL
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function updateAll() {
  const hasUsers = db.users.length > 0;
  document.getElementById('btnAddTraining').disabled  = !hasUsers;
  document.getElementById('btnAddWeight').disabled    = !hasUsers;
  document.getElementById('btnAddTraining2').disabled = !hasUsers;
  document.getElementById('btnAddWeight2').disabled   = !hasUsers;

  populateTrainingSelects();
  populateWeightSelects();
  renderUsers();
  renderTrainings();
  renderWeights();
  renderDashboard();
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  CUSTOM DATE PICKER  (fixed-position popover)
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
const dpState  = {};
const WEEKDAYS  = ['æ—¥','æœˆ','ç«','æ°´','æœ¨','é‡‘','åœŸ'];
const MONTHS_JP = ['1æœˆ','2æœˆ','3æœˆ','4æœˆ','5æœˆ','6æœˆ','7æœˆ','8æœˆ','9æœˆ','10æœˆ','11æœˆ','12æœˆ'];

// hidden-input id lookup
const DP_HIDDEN = { 'dp_t': 't_date', 'dp_w': 'w_date', 'dp_ew': 'ew_date', 'dp_et': 'et_date' };

function dpInit(id, defaultDate) {
  const d = defaultDate ? new Date(defaultDate + 'T00:00:00') : new Date();
  dpState[id] = { year: d.getFullYear(), month: d.getMonth(), ymOpen: false };
  // update display label & hidden value without closing
  const hiddenId = DP_HIDDEN[id];
  if (hiddenId && defaultDate) {
    document.getElementById(hiddenId).value = defaultDate;
    const [y,m,day] = defaultDate.split('-').map(Number);
    document.getElementById(id + '_display').textContent = y + 'å¹´' + m + 'æœˆ' + day + 'æ—¥';
  }
}

function dpToggle(id) {
  const cal  = document.getElementById(id + '_cal');
  const disp = document.getElementById(id + '_display');
  const isOpen = cal.classList.contains('open');

  dpCloseAll();

  if (!isOpen) {
    dpRender(id);          // build HTML first so size is real
    cal.classList.add('open');
    disp.classList.add('active');
    dpPosition(id);        // then position
  }
}

function dpPosition(id) {
  const cal  = document.getElementById(id + '_cal');
  const disp = document.getElementById(id + '_display');
  const rect = disp.getBoundingClientRect();
  const CAL_W = 280, CAL_H = 300;

  let left = rect.left;
  let top  = rect.bottom + 6;

  if (left + CAL_W > window.innerWidth - 8)  left = window.innerWidth - CAL_W - 8;
  if (left < 8) left = 8;
  if (top + CAL_H > window.innerHeight - 8)  top = rect.top - CAL_H - 6;
  if (top < 8) top = 8;

  cal.style.left = left + 'px';
  cal.style.top  = top  + 'px';
}

function dpCloseAll() {
  document.querySelectorAll('.datepicker-cal.open').forEach(c => c.classList.remove('open'));
  document.querySelectorAll('.datepicker-input.active').forEach(d => d.classList.remove('active'));
}

function dpClose(id) {
  document.getElementById(id + '_cal').classList.remove('open');
  document.getElementById(id + '_display').classList.remove('active');
}

function dpSetValue(id, dateStr) {
  const hiddenId = DP_HIDDEN[id];
  if (hiddenId) document.getElementById(hiddenId).value = dateStr;

  const [y,m,d] = dateStr.split('-').map(Number);
  document.getElementById(id + '_display').textContent = y + 'å¹´' + m + 'æœˆ' + d + 'æ—¥';

  dpState[id] = dpState[id] || {};
  dpState[id].year  = y;
  dpState[id].month = m - 1;
  dpState[id].ymOpen = false;
  dpClose(id);
}

function dpNav(id, delta) {
  const s = dpState[id];
  s.month += delta;
  if (s.month > 11) { s.month = 0;  s.year++; }
  if (s.month < 0)  { s.month = 11; s.year--; }
  dpRender(id);
}

function dpToggleYM(id) {
  dpState[id].ymOpen = !dpState[id].ymOpen;
  dpRender(id);
}

function dpRender(id) {
  const cal = document.getElementById(id + '_cal');
  if (!cal) return;
  if (!dpState[id]) dpState[id] = { year: new Date().getFullYear(), month: new Date().getMonth(), ymOpen: false };
  const s = dpState[id];
  const hiddenId = DP_HIDDEN[id];
  const currentVal = hiddenId ? document.getElementById(hiddenId).value : '';
  const todayStr = today();

  const firstDay    = new Date(s.year, s.month, 1).getDay();
  const daysInMonth = new Date(s.year, s.month + 1, 0).getDate();
  const daysInPrev  = new Date(s.year, s.month, 0).getDate();

  const curYear   = new Date().getFullYear();
  const yearOpts  = Array.from({length: 10}, (_, i) => curYear - 5 + i)
    .map(y => `<option value="${y}"${y === s.year ? ' selected' : ''}>${y}å¹´</option>`).join('');
  const monthOpts = MONTHS_JP.map((lbl, i) =>
    `<option value="${i}"${i === s.month ? ' selected' : ''}>${lbl}</option>`).join('');

  const pad = n => String(n).padStart(2, '0');
  const mkDate = (y, m, d) => `${y}-${pad(m)}-${pad(d)}`;

  let cells = '';

  // å‰æœˆã®æœ«å°¾
  const prevM = s.month === 0 ? 12 : s.month;
  const prevY = s.month === 0 ? s.year - 1 : s.year;
  for (let i = firstDay - 1; i >= 0; i--) {
    const d   = daysInPrev - i;
    const str = mkDate(prevY, prevM, d);
    cells += `<div class="cal-day other-month" data-date="${str}">${d}</div>`;
  }

  // å½“æœˆ
  for (let d = 1; d <= daysInMonth; d++) {
    const str = mkDate(s.year, s.month + 1, d);
    const cls = (str === todayStr ? ' today' : '') + (str === currentVal ? ' selected' : '');
    cells += `<div class="cal-day${cls}" data-date="${str}">${d}</div>`;
  }

  // æ¬¡æœˆã®å…ˆé ­
  const nextM  = s.month === 11 ? 1 : s.month + 2;
  const nextY  = s.month === 11 ? s.year + 1 : s.year;
  const total  = firstDay + daysInMonth;
  const fill   = total % 7 === 0 ? 0 : 7 - (total % 7);
  for (let d = 1; d <= fill; d++) {
    const str = mkDate(nextY, nextM, d);
    cells += `<div class="cal-day other-month" data-date="${str}">${d}</div>`;
  }

  const ymPanel = s.ymOpen
    ? `<div class="cal-ym-panel open">
        <select class="cal-ym-select" data-dp="${id}" data-type="year">${yearOpts}</select>
        <select class="cal-ym-select" data-dp="${id}" data-type="month">${monthOpts}</select>
       </div>`
    : `<div class="cal-ym-panel"></div>`;

  cal.innerHTML = `
    <div class="cal-header">
      <button class="cal-nav" data-dp="${id}" data-delta="-1">&#8249;</button>
      <div class="cal-month-label" data-dp="${id}" data-action="toggleYM">${s.year}å¹´ ${MONTHS_JP[s.month]}</div>
      <button class="cal-nav" data-dp="${id}" data-delta="1">&#8250;</button>
    </div>
    ${ymPanel}
    <div class="cal-weekdays">${WEEKDAYS.map(w => `<div class="cal-wd">${w}</div>`).join('')}</div>
    <div class="cal-days">${cells}</div>
  `;
}

// â”€â”€ ã‚«ãƒ¬ãƒ³ãƒ€ãƒ¼å†…ã‚¯ãƒªãƒƒã‚¯ã‚’ã‚¤ãƒ™ãƒ³ãƒˆãƒ‡ãƒªã‚²ãƒ¼ã‚·ãƒ§ãƒ³ã§å‡¦ç† â”€â”€
document.addEventListener('click', function(e) {
  const cal = e.target.closest('.datepicker-cal');
  const wrap = e.target.closest('.datepicker-wrap');

  // ã‚«ãƒ¬ãƒ³ãƒ€ãƒ¼å¤–ãƒ»å…¥åŠ›æ¬„å¤–ã‚¯ãƒªãƒƒã‚¯ â†’ å…¨é–‰
  if (!wrap && !cal) {
    dpCloseAll();
    return;
  }

  // ã‚«ãƒ¬ãƒ³ãƒ€ãƒ¼å†…ã®ã‚¯ãƒªãƒƒã‚¯å‡¦ç†
  if (cal) {
    e.stopPropagation();
    const id = cal.id.replace('_cal', '');

    // æ—¥ä»˜ã‚»ãƒ«
    const dayEl = e.target.closest('.cal-day');
    if (dayEl && dayEl.dataset.date) {
      dpSetValue(id, dayEl.dataset.date);
      return;
    }

    // å‰å¾ŒæœˆãƒŠãƒ“
    const navBtn = e.target.closest('.cal-nav[data-delta]');
    if (navBtn) {
      dpNav(id, parseInt(navBtn.dataset.delta));
      return;
    }

    // å¹´æœˆãƒ©ãƒ™ãƒ«ï¼ˆãƒˆã‚°ãƒ«ï¼‰
    const lbl = e.target.closest('.cal-month-label[data-action="toggleYM"]');
    if (lbl) {
      dpToggleYM(id);
      return;
    }

    // å¹´ãƒ»æœˆã‚»ãƒ¬ã‚¯ãƒˆ
    const sel = e.target.closest('.cal-ym-select');
    if (sel) {
      if (sel.dataset.type === 'year')  dpState[id].year  = parseInt(sel.value);
      if (sel.dataset.type === 'month') dpState[id].month = parseInt(sel.value);
      dpRender(id);
      return;
    }
  }
});

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  HEADER BUTTONS
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
document.getElementById('btnAddTraining').onclick = () => {
  dpInit('dp_t', today());
  openModal('modalTraining');
};
document.getElementById('btnAddWeight').onclick = () => {
  dpInit('dp_w', today());
  openModal('modalWeight');
};

// Set date defaults on modal open (from nav buttons)
document.querySelectorAll('[onclick*="modalTraining"]').forEach(btn => {
  btn.addEventListener('click', () => {
    dpInit('dp_t', today());
  });
});
document.querySelectorAll('[onclick*="modalWeight"]').forEach(btn => {
  btn.addEventListener('click', () => {
    dpInit('dp_w', today());
  });
});

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  DRAWER & TAB
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function toggleDrawer() {
  const drawer  = document.getElementById('drawer');
  const overlay = document.getElementById('drawerOverlay');
  const btn     = document.getElementById('hamburgerBtn');
  if (drawer.classList.contains('open')) { closeDrawer(); }
  else {
    drawer.classList.add('open');
    overlay.classList.add('open');
    btn.classList.add('open');
  }
}
function closeDrawer() {
  document.getElementById('drawer').classList.remove('open');
  document.getElementById('drawerOverlay').classList.remove('open');
  document.getElementById('hamburgerBtn').classList.remove('open');
}
function switchTab(btn) {
  document.querySelectorAll('.drawer-nav-btn').forEach(b => b.classList.remove('active'));
  btn.classList.add('active');
  const tab = btn.dataset.tab;
  document.querySelectorAll('.section').forEach(s => s.classList.remove('active'));
  document.getElementById('sec-' + tab).classList.add('active');
  if (tab === 'dashboard') renderDashboard();
  closeDrawer();
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  INIT
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
dpInit('dp_t', today());
dpInit('dp_w', today());

// åˆå›ãƒ­ãƒ¼ãƒ‰ï¼šæ—¢å­˜ã‚»ãƒƒã‚·ãƒ§ãƒ³ãŒã‚ã‚Œã°ãƒ‡ãƒ¼ã‚¿ã‚’å–å¾—ã—ã¦è¡¨ç¤º
(async () => {
  const { data: { session } } = await sb.auth.getSession();
  if (session && session.user) {
    currentUser = session.user;
    accessToken = session.access_token;
    _lastUserId = session.user.id;
    document.getElementById('loginScreen').style.display = 'none';
    document.getElementById('appScreen').style.display   = 'block';
    await loadAllData();
    updateAll();
  } else {
    document.getElementById('loginScreen').style.display = 'flex';
    document.getElementById('appScreen').style.display   = 'none';
  }
})();
</script>
</div><!-- /appScreen -->
</body>
</html>